<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>نظام إدارة صادر شركة الدعم</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root { 
      --main: #2563eb; 
      --main-dark: #1d4ed8; 
      --accent: #16a34a; 
      --bg: #f8fafc; 
      --card: #fff; 
      --text: #1e293b; 
      --muted: #64748b; 
      --border: #e2e8f0; 
      --radius: 12px; 
      --shadow: 0 4px 6px rgba(0,0,0,0.08); 
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Cairo', Tahoma, sans-serif;
      background: var(--bg);
      padding: 20px;
      color: var(--text);
      line-height: 1.6;
    }
    
    .container { max-width: 1400px; margin: 0 auto; }
    
    header {
      display: flex;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      background: linear-gradient(135deg, var(--main) 0%, var(--main-dark) 100%);
      padding: 20px;
      border-radius: var(--radius);
      color: #fff;
      box-shadow: var(--shadow);
    }
    
    h1 {
      font-size: 24px;
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 0;
    }
    
    .controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    input[type="search"], input[type="text"], input[type="date"], input[type="number"], select {
      padding: 12px 16px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      min-width: 200px;
      font-family: 'Cairo', sans-serif;
      font-size: 15px;
      background: #fff;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--main);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.08);
    }
    
    button {
      padding: 12px 18px;
      border-radius: var(--radius);
      border: 0;
      background: var(--main);
      color: #fff;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
    }
    
    button:hover {
      background: var(--main-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.08);
    }
    
    button.secondary { background: #94a3b8; }
    button.secondary:hover { background: #64748b; }
    
    button.success { background: var(--accent); }
    button.success:hover { background: #15803d; }
    
    .table-card {
      background: var(--card);
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 30px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      direction: rtl;
      table-layout: fixed;
      word-wrap: break-word;
      margin: 20px 0;
    }
    
    th, td {
      padding: 16px 14px;
      border-bottom: 1px solid var(--border);
      text-align: right;
      vertical-align: middle;
      font-size: 15px;
      position: relative;
    }
    
    thead th {
      background: #f1f5f9;
      position: sticky;
      top: 0;
      cursor: pointer;
      font-weight: 700;
      color: var(--text);
      transition: background 0.2s;
      user-select: none;
    }
    
    thead th:hover { background: #e2e8f0; }
    
    thead th .sort-ind {
      display: inline-block;
      width: 18px;
      margin-right: 8px;
      opacity: 0.7;
      font-size: 14px;
    }
    
    tbody tr:nth-child(even) { background: #fbfbfd; }
    tbody tr:hover { background-color: #f1f5f9; }
    
    .muted { color: var(--muted); font-size: 14px; }
    .small { font-size: 14px; }
    
    .filter-section {
      background: #f8fafc;
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: end;
      box-shadow: 0 2px 4px rgba(0,0,0,0.04);
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      min-width: 200px;
    }
    
    .filter-group label {
      font-size: 14px;
      color: var(--muted);
      font-weight: 600;
    }
    
    .date-range-container {
      display: flex;
      gap: 15px;
      align-items: end;
      flex-wrap: wrap;
    }
    
    .date-range-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .filter-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 15px 0;
    }
    
    .filter-tag {
      background: #e0f2fe;
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #0c4a6e;
      font-weight: 500;
    }
    
    .filter-tag button {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 0;
      font-size: 16px;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: #bae6fd;
    }
    
    .filter-tag button:hover { background: #7dd3fc; }
    
    .loading {
      display: none;
      text-align: center;
      padding: 40px;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }
    
    .loading.show { display: flex; }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #e2e8f0;
      border-top: 5px solid var(--main);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .no-results {
      text-align: center;
      padding: 40px;
      color: var(--muted);
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }
    
    .no-results.show { display: flex; }
    
    .stats {
      display: flex;
      gap: 20px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      flex: 1;
      min-width: 200px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--main);
      font-family: 'Cairo', sans-serif;
    }
    
    .stat-label {
      font-size: 14px;
      color: var(--muted);
    }
    
    .numeric { 
      font-family: 'Cairo', sans-serif; 
      font-variant-numeric: tabular-nums; 
    }
    
    .date-cell { white-space: nowrap; }
    .amount-cell { font-weight: 600; color: var(--accent); }
    
    .table-container {
      overflow-x: auto;
      max-width: 100%;
      margin: 20px 0;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }
    
    .last-updated {
      display: flex;
      justify-content: flex-end;
      margin-top: 15px;
      color: var(--muted);
      font-size: 14px;
      align-items: center;
      gap: 8px;
    }
    
    .quick-date-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    
    .quick-date-btn {
      padding: 8px 12px;
      background: #e2e8f0;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
    }
    
    .quick-date-btn:hover { background: #cbd5e1; }
    
    .conversion-badge {
      background: #fffbeb;
      color: #d97706;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      margin-left: 8px;
    }
    
    /* أنماط السحب لتغيير حجم الأعمدة */
    .resize-handle {
      position: absolute;
      top: 0;
      left: -5px;
      width: 10px;
      height: 100%;
      cursor: col-resize;
      z-index: 10;
    }
    
    .resizing {
      background-color: #f1f5f9;
      opacity: 0.8;
    }
    
    /* خلايا قابلة للنقر للفلترة */
    .clickable-cell {
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .clickable-cell:hover {
      background-color: #e0f2fe !important;
    }
    
    /* تحسينات للعرض على الجوال */
    @media (max-width: 1024px) {
      .filter-group { min-width: 160px; }
    }
    
    @media (max-width: 880px) {
      header { flex-direction: column; align-items: flex-start; }
      .controls { width: 100%; justify-content: center; }
      th, td { font-size: 14px; padding: 14px 10px; }
      .filter-section { flex-direction: column; align-items: stretch; }
      .filter-group { min-width: 100%; }
      input[type="search"], input[type="date"], select { min-width: 100%; }
      .resize-handle { display: none; } /* إخفاء مقابض السحب على الشاشات الصغيرة */
    }
    
    @media (max-width: 640px) {
      body { padding: 15px; }
      h1 { font-size: 20px; }
      button { padding: 10px 14px; font-size: 14px; }
      .stat-card { min-width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div style="display:flex;gap:12px;align-items:center;">
        <h1><i class="fas fa-file-contract"></i> نظام إدارة صادر شركة الدعم</h1>
        <div class="muted small">عرض البيانات مباشرة من Google Sheets — التواريخ تعرض بالميلادي والأرقام بالأرقام الغربية</div>
      </div>

      <div class="controls">
        <button id="refreshBtn" class="success"><i class="fas fa-sync-alt"></i> تحديث البيانات</button>
        <button id="resetBtn" class="secondary"><i class="fas fa-undo"></i> إعادة التعيين</button>
      </div>
    </header>

    <div class="stats">
      <div class="stat-card"><div class="stat-value"><span id="totalRecords">0</span></div><div class="stat-label">إجمالي السجلات</div></div>
      <div class="stat-card"><div class="stat-value"><span id="filteredRecords">0</span></div><div class="stat-label">السجلات المصفاة</div></div>
      <div class="stat-card"><div class="stat-value"><span id="totalValue">0</span></div><div class="stat-label">مجموع الرقم الإشاري (قابل للعد)</div></div>
    </div>

    <div class="filter-section">
      <div class="filter-group">
        <label for="globalSearch">بحث عام</label>
        <input id="globalSearch" type="search" placeholder="ابحث في جميع الحقول...">
      </div>

      <div class="filter-group">
        <label for="columnFilter">بحث في عمود محدد</label>
        <select id="columnFilter">
          <option value="all">جميع الأعمدة</option>
          <option value="0">الجهة الموجه لها</option>
          <option value="1">الموضوع</option>
          <option value="2">الرقم الإشاري</option>
          <option value="3">التاريخ</option>
          <option value="4">المكلف به</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="columnSearch">كلمة البحث</label>
        <input id="columnSearch" type="text" placeholder="اكتب الكلمة للبحث...">
      </div>

      <div class="filter-group">
        <label>&nbsp;</label>
        <button id="addFilterBtn"><i class="fas fa-filter"></i> إضافة فلتر</button>
      </div>

      <div style="min-width:260px;">
        <label class="small muted">نطاق التاريخ</label>
        <div class="date-range-container">
          <div class="date-range-group">
            <label for="dateFrom" class="small">من</label>
            <input id="dateFrom" type="date">
          </div>
          <div class="date-range-group">
            <label for="dateTo" class="small">إلى</label>
            <input id="dateTo" type="date">
          </div>
        </div>
        <div style="margin-top:8px;">
          <div class="quick-date-buttons">
            <button class="quick-date-btn" data-days="7">أسبوع</button>
            <button class="quick-date-btn" data-days="30">شهر</button>
            <button class="quick-date-btn" data-days="90">3 أشهر</button>
            <button class="quick-date-btn" data-days="365">سنة</button>
            <button class="quick-date-btn" data-days="0">إعادة تعيين</button>
          </div>
        </div>
      </div>
    </div>

    <div id="filterTags" class="filter-tags"></div>

    <div class="table-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;gap:15px;flex-wrap:wrap">
        <div class="small muted">
          <i class="fas fa-info-circle"></i> انقر على عنوان العمود للترتيب - انقر على خلية للفلترة حسب قيمتها
          <span class="conversion-badge">التحويل التلقائي: هجري ← ميلادي</span>
        </div>
        <div class="small muted">
          <i class="fas fa-arrows-alt-h"></i> اسحب نهاية العمود لتغيير عرضه
        </div>
      </div>

      <div id="loading" class="loading"><div class="spinner"></div><p>جاري تحميل البيانات...</p></div>

      <div class="table-container">
        <table id="dataTable">
          <thead>
            <tr>
              <th width="20%" data-col="0">الجهة الموجه لها <span class="sort-ind" id="sort-0"></span><div class="resize-handle"></div></th>
              <th width="25%" data-col="1">الموضوع <span class="sort-ind" id="sort-1"></span><div class="resize-handle"></div></th>
              <th width="15%" data-col="2">الرقم الإشاري <span class="sort-ind" id="sort-2"></span><div class="resize-handle"></div></th>
              <th width="15%" data-col="3">التاريخ <span class="sort-ind" id="sort-3"></span><div class="resize-handle"></div></th>
              <th width="25%" data-col="4">المكلف به <span class="sort-ind" id="sort-4"></span><div class="resize-handle"></div></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="noResults" class="no-results">
        <i class="fas fa-search" style="font-size:40px"></i>
        <h3>لا توجد نتائج</h3>
        <p>لم يتم العثور على أي سجلات تطابق معايير البحث المحددة</p>
      </div>

      <div class="last-updated">
        <i class="fas fa-clock"></i>
        <span id="lastUpdateTime">لم يتم التحديث بعد</span>
      </div>
    </div>
  </div>

  <script>
  /***************** رابط CSV الذي زوّدتني به *****************/
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSv-LIrm2oZEBfHK9hMt7Bz5HYJbW1n0aInzh-i0g9agDKrKyNbyYkshaV1GMgcnn8oGVO5OeIYlKRS/pub?output=csv";

  /***************** هياكل البيانات وحالة الواجهة *****************/
  const preprocessedData = { originalRows: [], convertedRows: [], dateCache: new Map() };
  let displayRows = [];
  let sortState = { col: 3, dir: 'desc' }; // افتراضي: ترتيب حسب التاريخ (الأحدث أولاً)
  let activeFilters = [];
  let searchDebounce = null;
  let lastUpdateTime = null;

  /***************** تحويل أرقام عربية → لاتينية *****************/
  function toLatinDigits(str) {
    if (str === undefined || str === null) return str;
    let s = String(str);
    const arabicIndic = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'};
    s = s.replace(/[٠-٩]/g, d => arabicIndic[d]);
    const persian = {'۰':'0','۱':'1','۲':'2','۳':'3','۴':'4','۵':'5','۶':'6','۷':'7','۸':'8','۹':'9'};
    s = s.replace(/[۰-۹]/g, d => persian[d]);
    return s;
  }

  /***************** تحويل الهجري ↔ JDN ↔ ميلادي *****************/
  function islamicToJDN(y, m, d) {
    return Math.floor((11 * y + 3) / 30) + 354 * y + 30 * m - Math.floor((m - 1) / 2) + d + 1948440 - 385;
  }
  function jdnToGregorian(jd) {
    let j = jd + 0.5;
    let Z = Math.floor(j);
    let F = j - Z;
    let A;
    if (Z < 2299161) A = Z;
    else {
      let alpha = Math.floor((Z - 1867216.25) / 36524.25);
      A = Z + 1 + alpha - Math.floor(alpha / 4);
    }
    let B = A + 1524;
    let C = Math.floor((B - 122.1) / 365.25);
    let D = Math.floor(365.25 * C);
    let E = Math.floor((B - D) / 30.6001);
    let day = B - D - Math.floor(30.6001 * E) + F;
    let month = (E < 14) ? E - 1 : E - 13;
    let year = (month > 2) ? C - 4716 : C - 4715;
    return new Date(year, month - 1, Math.floor(day));
  }
  function hijriToGregorian(hY, hM, hD) {
    const jdn = islamicToJDN(hY, hM, hD);
    return jdnToGregorian(jdn);
  }

  /***************** تحليل وتحويل تاريخ الخلية → Date ميلادي *****************/
  function parseAndConvertDate(value) {
    if (!value && value !== 0) return null;
    if (preprocessedData.dateCache.has(value)) return preprocessedData.dateCache.get(value);
    let raw = String(value).trim();
    raw = toLatinDigits(raw);
    const containsHijriMarker = /[هھـ]/i.test(String(value));
    const cleaned = raw.replace(/[^\d\/\-\s]/g, '').trim();
    let result = null;

    // ISO yyyy-mm-dd
    const iso = /^(\d{4})-(\d{1,2})-(\d{1,2})$/;
    const mIso = cleaned.match(iso);
    if (mIso) {
      const y = parseInt(mIso[1],10), mo = parseInt(mIso[2],10), d = parseInt(mIso[3],10);
      const date = new Date(y, mo-1, d);
      result = isNaN(date.getTime()) ? null : date;
    }

    // d/m/yyyy or d-m-yyyy or dd/mm/yy
    if (!result) {
      const dmy = /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/;
      const mDmy = cleaned.match(dmy);
      if (mDmy) {
        let day = parseInt(mDmy[1],10), month = parseInt(mDmy[2],10), year = parseInt(mDmy[3],10);
        if (year < 100) year += 2000;
        if (containsHijriMarker || (year >= 1300 && year <= 1600)) {
          try {
            const g = hijriToGregorian(year, month, day);
            result = isNaN(g.getTime()) ? null : g;
          } catch (e) {
            const date = new Date(year, month-1, day);
            result = isNaN(date.getTime()) ? null : date;
          }
        } else {
          const date = new Date(year, month-1, day);
          result = isNaN(date.getTime()) ? null : date;
        }
      }
    }

    // محاولة عامة
    if (!result) {
      const tryDate = new Date(toLatinDigits(String(value)));
      result = isNaN(tryDate.getTime()) ? null : tryDate;
    }

    preprocessedData.dateCache.set(value, result);
    return result;
  }

  /***************** تنسيقات العرض *****************/
  function pad2(n) { return String(n).padStart(2,'0'); }
  function formatDate(date) {
    if (!date) return "";
    const d = date.getDate();
    const m = date.getMonth() + 1;
    const y = date.getFullYear();
    return `${pad2(d)}/${pad2(m)}/${y}`;
  }
  function formatNumber(num) {
    if (num == null || isNaN(num)) return "0";
    return new Intl.NumberFormat('en-US').format(num);
  }

  /***************** CSV parser بسيط وموثوق *****************/
  function parseCSV(text) {
    const rows = [];
    let cur = '';
    let row = [];
    let inQuotes = false;
    
    for (let i = 0; i < text.length; i++) {
      const ch = text[i];
      const next = text[i+1];
      
      if (ch === '"') {
        if (inQuotes && next === '"') { cur += '"'; i++; }
        else { inQuotes = !inQuotes; }
      } else if (ch === ',' && !inQuotes) {
        row.push(cur); 
        cur = '';
      } else if ((ch === '\n' || ch === '\r') && !inQuotes) {
        if (ch === '\r' && text[i+1] === '\n') i++;
        if (cur !== '' || row.length > 0) {
          row.push(cur);
          rows.push(row);
          row = []; 
          cur = '';
        }
      } else {
        cur += ch;
      }
    }
    
    if (cur !== '' || row.length > 0) { 
      row.push(cur); 
      rows.push(row); 
    }
    
    return rows.map(r => r.map(c => String(c).trim())).filter(r => r.some(c => c !== ""));
  }

  /***************** معالجة مسبقة للبيانات *****************/
  function preprocessData(rows) {
    return rows.map(r => {
      const processedRow = [];
      for (let i = 0; i < 5; i++) processedRow[i] = (r[i] !== undefined) ? r[i] : "";
      processedRow.convertedDate = parseAndConvertDate(processedRow[3] || "");
      // تحويل الرقم الإشاري لعرض ثابت (نترك النص كما هو، لكن نخزّن النسخة الرقمية للنمط إذا احتجنا)
      processedRow[2] = toLatinDigits(processedRow[2] || "");
      return processedRow;
    });
  }

  /***************** مقارنة ذكية للفرز *****************/
  function smartCompare(a, b) {
    if ((a == null || a === "") && (b == null || b === "")) return 0;
    if (a == null || a === "") return -1;
    if (b == null || b === "") return 1;
    
    // إذا كان كلاهما تواريخ
    const da = parseAndConvertDate(a);
    const db = parseAndConvertDate(b);
    if (da && db) return da - db;
    
    // محاولة رقمية
    const na = Number(String(toLatinDigits(a)).replace(/[^0-9.\-]/g,'')); 
    const nb = Number(String(toLatinDigits(b)).replace(/[^0-9.\-]/g,''));
    if (!isNaN(na) && !isNaN(nb)) return na - nb;
    
    return String(a).localeCompare(String(b), 'ar');
  }

  /***************** عرض الجدول وتحديث الإحصائيات *****************/
  function renderTable(rows) {
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";

    if (!rows || rows.length === 0) {
      document.getElementById("noResults").classList.add("show");
      document.getElementById("totalRecords").textContent = formatNumber(preprocessedData.originalRows.length || 0);
      document.getElementById("filteredRecords").textContent = formatNumber(0);
      document.getElementById("totalValue").textContent = formatNumber(0);
      return;
    }

    document.getElementById("noResults").classList.remove("show");

    rows.forEach(r => {
      const tr = document.createElement("tr");
      for (let c = 0; c < 5; c++) {
        const td = document.createElement("td");
        let cell = r[c] ?? "";

        if (c === 2) { // الرقم الإشاري
          td.textContent = cell;
          td.classList.add("amount-cell");
        } else if (c === 3) { // التاريخ
          if (r.convertedDate) {
            td.textContent = formatDate(r.convertedDate);
            td.classList.add('date-cell');
          } else {
            td.textContent = cell;
          }
        } else {
          td.textContent = cell;
        }

        if (c !== 3) { // خلايا قابلة للنقر (عدا التاريخ)
          td.classList.add('clickable-cell');
          td.dataset.column = c;
          td.dataset.value = cell;
        }
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    });

    document.getElementById("totalRecords").textContent = formatNumber(preprocessedData.originalRows.length || 0);
    document.getElementById("filteredRecords").textContent = formatNumber(rows.length || 0);

    // حساب مجموع القيم الرقمية الموجودة في العمود 2 (إذا أمكن استخراج أرقام)
    const totalRefs = rows.reduce((sum, r) => {
      const numText = String(toLatinDigits(r[2] || '')).replace(/[^0-9.\-]/g, '');
      const n = Number(numText);
      return sum + (isNaN(n) ? 0 : n);
    }, 0);
    document.getElementById("totalValue").textContent = formatNumber(totalRefs);
  }

  /***************** تطبيق الفلاتر والفرز (يشمل نطاق التاريخ) *****************/
  function applyFiltersAndSort() {
    document.getElementById("loading").classList.add("show");

    setTimeout(() => {
      const globalQ = toLatinDigits(document.getElementById("globalSearch").value.trim().toLowerCase());
      let filtered = [...preprocessedData.convertedRows];

      // بحث عام
      if (globalQ !== "") {
        filtered = filtered.filter(r =>
          r.some((cell, idx) => {
            if (idx === 3 && r.convertedDate) {
              return formatDate(r.convertedDate).toLowerCase().includes(globalQ);
            }
            return toLatinDigits(String(cell || '')).toLowerCase().includes(globalQ);
          })
        );
      }

      // فلاتر مضافة
      activeFilters.forEach(filter => {
        filtered = filtered.filter(row => {
          const col = filter.column;
          const val = toLatinDigits(String(filter.value).toLowerCase());
          if (col === "all") {
            return row.some((cell, idx) => {
              if (idx === 3 && row.convertedDate) {
                return formatDate(row.convertedDate).toLowerCase().includes(val);
              }
              return toLatinDigits(String(cell || '')).toLowerCase().includes(val);
            });
          } else {
            if (parseInt(col,10) === 3 && row.convertedDate) {
              return formatDate(row.convertedDate).toLowerCase().includes(val);
            }
            const cv = toLatinDigits(String(row[col] || '')).toLowerCase();
            return cv.includes(val);
          }
        });
      });

      // نطاق التاريخ
      const dateFromVal = document.getElementById("dateFrom").value;
      const dateToVal = document.getElementById("dateTo").value;
      let from = dateFromVal ? new Date(dateFromVal) : null;
      let to = dateToVal ? new Date(dateToVal) : null;
      if (to) to.setHours(23,59,59,999);

      if (from || to) {
        filtered = filtered.filter(row => {
          const d = row.convertedDate;
          if (!d) return false;
          if (from && d < from) return false;
          if (to && d > to) return false;
          return true;
        });
      }

      // فرز
      if (sortState.col !== null && sortState.col !== undefined) {
        const col = parseInt(sortState.col, 10);
        const dir = sortState.dir === 'asc' ? 1 : -1;
        filtered.sort((a,b) => {
          let aVal = a[col] || "";
          let bVal = b[col] || "";
          if (col === 3) { aVal = a.convertedDate || ""; bVal = b.convertedDate || ""; }
          return smartCompare(aVal, bVal) * dir;
        });
      }

      displayRows = filtered;
      renderTable(displayRows);
      document.getElementById("loading").classList.remove("show");
    }, 30);
  }

  /***************** إدارة الفلاتر المرئية *****************/
  function addFilter() {
    const column = document.getElementById("columnFilter").value;
    const value = document.getElementById("columnSearch").value.trim();
    const condition = "contains";
    if (!value) { alert("يرجى إدخال قيمة للبحث عنها"); return; }
    const exists = activeFilters.some(f => f.column === column && f.value === value && f.condition === condition);
    if (exists) { alert("هذا الفلتر مضاف مسبقاً"); return; }
    activeFilters.push({ column, value, condition });
    updateFilterTags();
    applyFiltersAndSort();
    document.getElementById("columnSearch").value = "";
  }

  function addFilterFromCell(column, value) {
    activeFilters.push({ column: String(column), value: String(value), condition: "contains" });
    updateFilterTags();
    applyFiltersAndSort();
  }

  function removeFilter(i) {
    activeFilters.splice(i, 1);
    updateFilterTags();
    applyFiltersAndSort();
  }

  function updateFilterTags() {
    const container = document.getElementById("filterTags");
    container.innerHTML = "";
    activeFilters.forEach((f, i) => {
      let colName = "جميع الأعمدة";
      if (f.column !== "all") {
        const header = document.querySelector(`th[data-col="${f.column}"]`);
        colName = header ? header.textContent.split(' ')[0] : `العمود ${f.column}`;
      }
      const tag = document.createElement('div');
      tag.className = 'filter-tag';
      tag.innerHTML = `${colName} يحتوي على "${f.value}" <button onclick="removeFilter(${i})">×</button>`;
      container.appendChild(tag);
    });
  }

  /***************** جلب البيانات من Google Sheets (CSV) مع معالجة الأخطاء *****************/
  async function loadDataFromCSV() {
    try {
      document.getElementById("loading").classList.add("show");
      const resp = await fetch(SHEET_CSV_URL, { cache: "no-store" });

      if (!resp.ok) {
        // رسائل خطأ أوضح للمستخدم
        let message = `فشل جلب الملف: ${resp.status}`;
        if (resp.status === 400) {
          message += " — (400) عادةً يعني أن رابط الـ CSV غير صحيح أو أن ملف Google Sheets لم يُنشر بشكل صحيح. تأكد من: 1) رابط 'publish to web' صحيح، 2) استخدام output=csv، 3) ليس هناك قيود وصول.";
        } else if (resp.status === 403 || resp.status === 401) {
          message += " — (صلاحيات) تحقق من إعدادات المشاركة في Google Sheets: يجب أن تكون 'Anyone with the link' أو تم نشره للنشر العام.";
        } else if (resp.status === 404) {
          message += " — (404) الرابط غير موجود. تأكد من صحة رابط الـ CSV.";
        } else {
          message += " — تحقق من الرابط وصلاحيات المشاركة أو من وجود قيود CORS.";
        }
        throw new Error(message);
      }

      const text = await resp.text();
      const parsed = parseCSV(text);

      if (!parsed || parsed.length === 0) {
        throw new Error("الملف فارغ أو غير قابل للقراءة بواسطة المتصفح (تأكد أن الرابط يشير إلى CSV مُنشر).");
      }

      // مسح الكاش القديم
      preprocessedData.dateCache.clear();

      // افترض أن الصف الأول ترويسة ونقصه
      const dataRows = parsed.slice(1).map(r => {
        const row = [];
        for (let i = 0; i < 5; i++) row[i] = (r[i] !== undefined) ? r[i] : "";
        return row;
      }).filter(r => r.some(c => c !== ""));

      preprocessedData.originalRows = dataRows;
      preprocessedData.convertedRows = preprocessData(preprocessedData.originalRows);

      lastUpdateTime = new Date();
      document.getElementById("lastUpdateTime").textContent =
        `آخر تحديث: ${formatDate(lastUpdateTime)} ${lastUpdateTime.toLocaleTimeString('en-US')}`;

      // تحديث حالة الفرز الافتراضية
      sortState = { col: 3, dir: 'desc' };
      for (let i = 0; i < 5; i++) {
        const el = document.getElementById("sort-"+i);
        el.textContent = (i === 3) ? "▼" : "";
      }

      applyFiltersAndSort();
      return true;
    } catch (err) {
      console.error(err);
      alert("حدث خطأ عند تحميل البيانات:\n" + err.message + "\n\nنصائح: تأكد أن ملف Google Sheets 'مُنشر' عبر File → Publish to web ثم استخدم رابط CSV (output=csv). أيضاً راجع إعدادات المشاركة لتكون 'Anyone with the link'.");
      return false;
    } finally {
      document.getElementById("loading").classList.remove("show");
    }
  }

  /***************** زر التحديث مع واجهة مستخدم مريحة *****************/
  async function refreshData() {
    const btn = document.getElementById("refreshBtn");
    btn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> جاري التحديث...';
    btn.disabled = true;
    try {
      const ok = await loadDataFromCSV();
      if (ok) {
        console.log("تم تحديث البيانات بنجاح");
      }
    } catch (e) {
      console.error(e);
    } finally {
      btn.innerHTML = '<i class="fas fa-sync-alt"></i> تحديث البيانات';
      btn.disabled = false;
    }
  }

  /***************** ضبط تغيير حجم الأعمدة *****************/
  function setupColumnResizing() {
    const handles = document.querySelectorAll('.resize-handle');
    let isResizing = false, currentColumn = null, startX = 0, startWidth = 0;

    handles.forEach(handle => {
      handle.addEventListener('mousedown', (e) => {
        isResizing = true;
        currentColumn = handle.parentElement;
        startX = e.pageX;
        startWidth = currentColumn.offsetWidth;
        currentColumn.classList.add('resizing');
        document.body.style.userSelect = 'none';
        document.body.style.cursor = 'col-resize';
        e.preventDefault();
      });
    });

    document.addEventListener('mousemove', (e) => {
      if (!isResizing || !currentColumn) return;
      const width = startWidth + (startX - e.pageX);
      if (width > 50) { currentColumn.style.width = width + 'px'; }
    });

    document.addEventListener('mouseup', () => {
      if (isResizing) {
        isResizing = false;
        if (currentColumn) { currentColumn.classList.remove('resizing'); currentColumn = null; }
        document.body.style.userSelect = '';
        document.body.style.cursor = '';
      }
    });
  }

  /***************** تهيئة الواجهة والأحداث *****************/
  function setupUI() {
    document.getElementById("globalSearch").addEventListener("input", () => {
      clearTimeout(searchDebounce);
      searchDebounce = setTimeout(() => applyFiltersAndSort(), 400);
    });

    document.getElementById("columnSearch").addEventListener("input", () => {
      clearTimeout(searchDebounce);
      searchDebounce = setTimeout(() => applyFiltersAndSort(), 400);
    });

    document.getElementById("addFilterBtn").addEventListener("click", addFilter);

    document.getElementById("resetBtn").addEventListener("click", () => {
      document.getElementById("globalSearch").value = "";
      document.getElementById("columnSearch").value = "";
      document.getElementById("dateFrom").value = "";
      document.getElementById("dateTo").value = "";
      activeFilters = [];
      sortState = { col: 3, dir: 'desc' };
      for (let i = 0; i < 5; i++) {
        const el = document.getElementById("sort-"+i);
        el.textContent = (i === 3) ? "▼" : "";
      }
      updateFilterTags();
      applyFiltersAndSort();
      alert("تمت إعادة التعيين");
    });

    document.getElementById("refreshBtn").addEventListener("click", refreshData);

    document.querySelectorAll(".quick-date-btn").forEach(btn => {
      btn.addEventListener("click", (e) => {
        const days = parseInt(e.currentTarget.dataset.days, 10);
        const today = new Date();
        if (days === 0) {
          document.getElementById("dateFrom").value = "";
          document.getElementById("dateTo").value = "";
        } else {
          const from = new Date();
          from.setDate(today.getDate() - days + 1);
          document.getElementById("dateFrom").value = from.toISOString().split('T')[0];
          document.getElementById("dateTo").value = today.toISOString().split('T')[0];
        }
        applyFiltersAndSort();
      });
    });

    document.querySelectorAll("#dataTable thead th").forEach(th => {
      th.addEventListener("click", () => {
        const col = parseInt(th.dataset.col, 10);
        if (sortState.col === col) {
          sortState.dir = sortState.dir === "asc" ? "desc" : "asc";
        } else {
          sortState.col = col;
          sortState.dir = "desc";
        }
        for (let i = 0; i < 5; i++) {
          const el = document.getElementById("sort-"+i);
          el.textContent = (i === sortState.col) ? (sortState.dir === "asc" ? "▲" : "▼") : "";
        }
        applyFiltersAndSort();
      });
    });

    // إعداد تغيير حجم الأعمدة
    setupColumnResizing();

    // النقر على الخلايا لإضافة فلتر (عدا عمود التاريخ)
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('clickable-cell')) {
        const column = e.target.dataset.column;
        const value = e.target.dataset.value;
        if (value && value.trim() !== '') {
          // ضع قيمة الفلتر في الاختيارات ثم أضف فلتر
          document.getElementById("columnFilter").value = column;
          document.getElementById("columnSearch").value = value;
          addFilter();
        }
      }
    });
  }

  // بدء التشغيل
  document.addEventListener('DOMContentLoaded', function() {
    setupUI();
    loadDataFromCSV();

    // تحديث تلقائي كل 5 دقائق
    setInterval(refreshData, 5 * 60 * 1000);
  });

  </script>
</body>
</html>

