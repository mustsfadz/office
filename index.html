<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ุงูุชููููุงุช ูุงููุญุงุถุฑ</title>
  <style>
    :root{
      --main:#0d6efd;
      --accent:#198754;
      --bg:#f4f6f9;
      --card:#ffffff;
      --muted:#6c757d;
      --error:#dc3545;
      --warning:#ffc107;
    }
    body{
      font-family: "Cairo", Tahoma, sans-serif;
      background: var(--bg);
      margin:0;
      padding:18px;
      color:#222;
    }
    .container{
      max-width:1200px;
      margin:0 auto;
    }
    header{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:14px;
    }
    h1{font-size:20px;margin:0}
    .controls{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    input[type="search"], select {
      padding:8px 10px;
      border-radius:8px;
      border:1px solid #ddd;
      min-width:180px;
    }
    button {
      padding:8px 12px;
      border-radius:8px;
      border:0;
      background:var(--main);
      color:#fff;
      cursor:pointer;
      transition: background 0.2s;
    }
    button:hover {
      background:#0b5ed7;
    }
    button.secondary{
      background:#6c757d;
    }
    button.secondary:hover{
      background:#5c636a;
    }
    .table-card{
      background:var(--card);
      padding:12px;
      border-radius:10px;
      box-shadow:0 4px 12px rgba(0,0,0,0.06);
    }
    table{
      width:100%;
      border-collapse:collapse;
      direction:rtl;
      table-layout:fixed;
      word-wrap:break-word;
    }
    th, td{
      padding:10px 8px;
      border-bottom:1px solid #eee;
      text-align:right;
      vertical-align:middle;
      font-size:14px;
    }
    thead th{
      background:linear-gradient(0deg, rgba(255,255,255,0.02), rgba(255,255,255,0.02));
      position:relative;
      cursor:pointer;
      user-select:none;
    }
    thead th .sort-ind {
      display:inline-block;
      width:10px;
      margin-left:8px;
      opacity:0.7;
    }
    tbody tr:nth-child(even){
      background:#fbfbfd;
    }
    tbody tr:hover {
      background-color: rgba(13, 110, 253, 0.05);
    }
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:13px}
    .actions { display:flex; gap:6px; align-items:center; }
    .filter-section {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .filter-section > div {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .filter-section label {
      font-size: 13px;
      color: var(--muted);
    }
    .advanced-filters {
      display: none;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #eee;
    }
    .advanced-filters.show {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    .toggle-filters {
      background: none;
      border: none;
      color: var(--main);
      cursor: pointer;
      font-size: 13px;
      padding: 5px;
    }
    .filter-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .filter-tag {
      background-color: #e9ecef;
      border-radius: 16px;
      padding: 4px 10px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .filter-tag button {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 0;
      font-size: 14px;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    .filter-tag button:hover {
      background-color: #dee2e6;
    }
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }
    .loading.show {
      display: block;
    }
    .no-results {
      text-align: center;
      padding: 30px;
      color: var(--muted);
    }
    @media (max-width:880px){
      th, td { font-size:13px; padding:8px 6px; }
      header{flex-direction:column;align-items:flex-start;gap:10px}
      .filter-section > div {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>๐ ุงูุชููููุงุช ูุงููุญุงุถุฑ</h1>
        <div class="muted small">ุนุฑุถ ุงูุจูุงูุงุช ูุจุงุดุฑุฉ ูู Google Sheets โ ุงูุตู ุงูุฃูู ูุนุชุจุฑ ุนูุงููู ููู ูุนุฑุถ ูุจูุงูุงุช</div>
      </div>

      <div class="controls">
        <!-- ุจุญุซ ุนุงู -->
        <input id="globalSearch" type="search" placeholder="ุจุญุซ ุนุงู... (ุงุณู ุงูููููุ ุจูุงู ุงูุนููุ ุฑูู ...)">

        <!-- ุฒุฑ ุฅุนุงุฏุฉ ุชุนููู -->
        <button id="resetBtn" class="secondary">ุฅุนุงุฏุฉ ุชุนููู ุงูููุงุชุฑ</button>
      </div>
    </header>

    <div class="filter-section">
      <div>
        <label for="columnFilter">ููุชุฑุฉ ุญุณุจ ุงูุนููุฏ:</label>
        <select id="columnFilter">
          <option value="all">ูู ุงูุฃุนูุฏุฉ</option>
          <option value="0">ุงุณู ุงููููู</option>
          <option value="1">ุจูุงู ุงูุนูู</option>
          <option value="2">ูููุฉ ุงูุชูููู</option>
          <option value="3">ุฑูู ุงูุชูููู</option>
          <option value="4">ุงูุชุงุฑูุฎ</option>
          <option value="5">ูููุน ุงูุนูู</option>
          <option value="6">ุงููุฏุฉ</option>
        </select>
      </div>
      
      <div>
        <label for="columnSearch">ูุต ุงูุจุญุซ:</label>
        <input id="columnSearch" type="search" placeholder="ุงูุชุจ ูุต ุงูุจุญุซ ููุง">
      </div>
      
      <div>
        <label for="filterCondition">ุดุฑุท ุงูููุชุฑุฉ:</label>
        <select id="filterCondition">
          <option value="contains">ูุญุชูู ุนูู</option>
          <option value="equals">ูุณุงูู</option>
          <option value="startsWith">ูุจุฏุฃ ุจู</option>
          <option value="endsWith">ููุชูู ุจู</option>
          <option value="greater">ุฃูุจุฑ ูู</option>
          <option value="less">ุฃูู ูู</option>
        </select>
      </div>
      
      <div>
        <label>&nbsp;</label>
        <button id="addFilterBtn">ุฅุถุงูุฉ ููุชุฑ</button>
      </div>
    </div>
    
    <button id="toggleFilters" class="toggle-filters">+ ุฅุธูุงุฑ/ุฅุฎูุงุก ุงูููุงุชุฑ ุงููุชูุฏูุฉ</button>
    
    <div id="advancedFilters" class="advanced-filters">
      <div>
        <label for="dateFrom">ูู ุชุงุฑูุฎ:</label>
        <input id="dateFrom" type="date">
      </div>
      
      <div>
        <label for="dateTo">ุฅูู ุชุงุฑูุฎ:</label>
        <input id="dateTo" type="date">
      </div>
      
      <div>
        <label for="valueMin">ูููุฉ ุงูุชูููู ูู:</label>
        <input id="valueMin" type="number" placeholder="ุงูุญุฏ ุงูุฃุฏูู">
      </div>
      
      <div>
        <label for="valueMax">ูููุฉ ุงูุชูููู ุฅูู:</label>
        <input id="valueMax" type="number" placeholder="ุงูุญุฏ ุงูุฃูุตู">
      </div>
    </div>
    
    <div id="filterTags" class="filter-tags"></div>

    <div class="table-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:12px;flex-wrap:wrap">
        <div class="small muted">ุงููุฑ ุนูู ุนููุงู ุงูุนููุฏ ูููุฑุฒ (ุตุนูุฏ / ูุจูุท). ุงููุฑุฒ ูุชุนุฑู ุชููุงุฆูุงู ุนูู ุงูุฃุฑูุงู ูุงูุชูุงุฑูุฎ.</div>
        <div class="actions">
          <button id="exportBtn">ุชุตุฏูุฑ CSV ูุฑุดุญ</button>
        </div>
      </div>

      <div id="loading" class="loading">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</div>
      
      <table id="dataTable" aria-describedby="ุฌุฏูู ุงูุชููููุงุช">
        <thead>
          <tr>
            <th data-col="0">ุงุณู ุงููููู <span class="sort-ind" id="sort-0"></span></th>
            <th data-col="1">ุจูุงู ุงูุนูู <span class="sort-ind" id="sort-1"></span></th>
            <th data-col="2">ูููุฉ ุงูุชูููู <span class="sort-ind" id="sort-2"></span></th>
            <th data-col="3">ุฑูู ุงูุชูููู <span class="sort-ind" id="sort-3"></span></th>
            <th data-col="4">ุงูุชุงุฑูุฎ <span class="sort-ind" id="sort-4"></span></th>
            <th data-col="5">ูููุน ุงูุนูู <span class="sort-ind" id="sort-5"></span></th>
            <th data-col="6">ุงููุฏุฉ <span class="sort-ind" id="sort-6"></span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      
      <div id="noResults" class="no-results" style="display: none;">ูู ูุชู ุงูุนุซูุฑ ุนูู ูุชุงุฆุฌ ุชุทุงุจู ูุนุงููุฑ ุงูุจุญุซ</div>

      <div id="info" class="muted small" style="margin-top:10px"></div>
    </div>
  </div>

  <script>
  /****************************************************************
   * ุชูููู: ุถุน ุฑุงุจุท CSV ุงูููุดูุฑ ูู Google Sheets ููุง
   ****************************************************************/
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSv-LIrm2oZEBfHK9hMt7Bz5HYJbW1n0aInzh-i0g9agDKrKyNbyYkshaV1GMgcnn8oGVO5OeIYlKRS/pub?gid=0&single=true&output=csv";

  // ูุตูููุฉ ุฃุตููุฉ ููุตููู (ูู ุตู ุนุจุงุฑุฉ ุนู ูุตูููุฉ ุฃุนูุฏุฉ)
  let originalRows = [];
  // ุญุงูุฉ ุงูุนุฑุถ ุจุนุฏ ุงูููุชุฑุฉ/ุงููุฑุฒ
  let displayRows = [];
  // ูุนูููุงุช ุงููุฑุฒ ุงูุญุงููุฉ
  let sortState = { col: null, dir: null }; // dir: "asc" | "desc"
  // ุงูููุงุชุฑ ุงููุดุทุฉ
  let activeFilters = [];
  // Debounce timer
  let searchDebounce;

  /***************** ุฃุฏูุงุช ูุณุงุนุฏุฉ *****************/
  // ุฏุงูุฉ CSV parser ุจุณูุทุฉ ููููุง ุชุฏุนู ุงูุญููู ุงููุญุงุทุฉ ุจุนูุงูุงุช ุงูุชุจุงุณ ูcommas ุฏุงุฎู ุงูุญููู
  function parseCSV(text){
    const rows = [];
    let cur = '';
    let row = [];
    let inQuotes = false;
    for (let i=0;i<text.length;i++){
      const ch = text[i];
      const next = text[i+1];
      if (ch === '"' ) {
        if (inQuotes && next === '"') { // escaped quote
          cur += '"';
          i++; // ุชุฎุทู ุงูุซุงูู
        } else {
          inQuotes = !inQuotes;
        }
      } else if (ch === ',' && !inQuotes){
        row.push(cur);
        cur = '';
      } else if ((ch === '\n' || ch === '\r') && !inQuotes){
        // handle CRLF and LF
        if (ch === '\r' && text[i+1] === '\n') { /* skip, will be handled once */ }
        if (cur !== '' || row.length>0) {
          row.push(cur);
          rows.push(row);
          row = [];
          cur = '';
        } else {
          // empty line -> skip
        }
      } else {
        cur += ch;
      }
    }
    // ููุงูุฉ ุงูููู
    if (cur !== '' || row.length>0) {
      row.push(cur);
      rows.push(row);
    }
    // ุฅุฒุงูุฉ ุฃู ุตููู ูููุง ูุงุฑุบุฉ
    return rows.map(r => r.map(c => c.trim())).filter(r => r.some(cell => cell !== ""));
  }

  // ูุญุงููุฉ ุชุญููู ูุต ุฅูู ุฑูู (ุชูุธูู ุงูููุงุตู - ุขูุงู - ุนููุงุช)
  function toNumber(value){
    if (value == null) return NaN;
    // ุฅุฒุงูุฉ ุฃู ุฑููุฒ ุบูุฑ ุฑูููุฉ ุฅูุง ุงูููุทุฉ ูุงูุณุงูุจ
    const cleaned = value.replace(/[^\d\.\-\/]/g, '') // keep digits, dot, minus, slash
                         .replace(/,+/g,''); // remove commas
    const n = parseFloat(cleaned);
    return isNaN(n) ? NaN : n;
  }

  // ูุญุงููุฉ ุชุญููู ูุต ุฅูู ุชุงุฑูุฎ (ูุฏุนู ุตูุบ ุดุงุฆุนุฉ dd/mm/yyyy ุฃู yyyy-mm-dd ุฃู dd-mm-yyyy)
  function toDate(value){
    if (!value) return null;
    // ุฅุฒุงูุฉ ุงููุณุงูุงุช
    const v = value.trim();
    // ุฅุฐุง ISO-like
    const iso = /^\d{4}-\d{1,2}-\d{1,2}$/;
    const dmy = /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/;
    if (iso.test(v)){
      const d = new Date(v);
      return isNaN(d.getTime()) ? null : d;
    }
    const m = v.match(dmy);
    if (m){
      let day = parseInt(m[1],10), month = parseInt(m[2],10), year = parseInt(m[3],10);
      if (year < 100) year += 2000;
      const d = new Date(year, month-1, day);
      return isNaN(d.getTime()) ? null : d;
    }
    // ูุญุงููุฉ ุนุงูุฉ
    const tryDate = new Date(v);
    return isNaN(tryDate.getTime()) ? null : tryDate;
  }

  // ููุงุฑูุฉ ุฐููุฉ ุจูู ูููุชูู: ุชุญุงูู ุฃู ุชุนุชุจุฑูุง ุชุงุฑูุฎ -> ุฑูู -> ูุต
  function smartCompare(a, b){
    // null/empty handling
    if ((a==null || a==="") && (b==null || b==="")) return 0;
    if (a==null || a==="") return -1;
    if (b==null || b==="") return 1;

    // ุงูุชุงุฑูุฎ
    const da = toDate(a);
    const db = toDate(b);
    if (da && db) return da - db;

    // ุฑูู
    const na = toNumber(a);
    const nb = toNumber(b);
    if (!isNaN(na) && !isNaN(nb)) return na - nb;

    // ูุต (localeCompare ููุนุฑุจูุฉ)
    return a.toString().localeCompare(b.toString(), 'ar');
  }

  /***************** ุฑูุฏุฑ ุงูุฌุฏูู *****************/
  function renderTable(rows){
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";
    
    if (rows.length === 0) {
      document.getElementById("noResults").style.display = "block";
    } else {
      document.getElementById("noResults").style.display = "none";
      const maxShow = rows.length;
      for (let i=0;i<maxShow;i++){
        const r = rows[i];
        const tr = document.createElement("tr");
        for (let c=0;c<7;c++){
          const td = document.createElement("td");
          td.textContent = r[c] ?? "";
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
    }
    
    // ุชุญุฏูุซ ูุนูููุงุช
    document.getElementById("info").textContent = `ุนุฑุถ ${rows.length} ูุชูุฌุฉ ูู ${originalRows.length} ุณุฌู`;
  }

  /***************** ุชุทุจูู ุงูููุชุฑุฉ ูุงููุฑุฒ *****************/
  function applyFiltersAndSort(){
    // ุฅุธูุงุฑ ูุคุดุฑ ุงูุชุญููู
    document.getElementById("loading").classList.add("show");
    
    // ุงุณุชุฎุฏุงู setTimeout ููุณูุงุญ ุจูุงุฌูุฉ ุงููุณุชุฎุฏู ุจุงูุชุญุฏูุซ ูุจู ุงููุนุงูุฌุฉ ุงูุซูููุฉ
    setTimeout(() => {
      // ููุชุฑุฉ ุญุณุจ ุงูุจุญุซ ุงูุนุงู
      const globalQ = document.getElementById("globalSearch").value.trim().toLowerCase();
      
      // ููุชุฑุฉ ุญุณุจ ุงูููุงุชุฑ ุงููุดุทุฉ
      let filteredRows = originalRows;
      
      // ุชุทุจูู ุงูุจุญุซ ุงูุนุงู ุฅุฐุง ูุงู ููุฌูุฏุงู
      if (globalQ !== "") {
        filteredRows = filteredRows.filter(r => {
          return r.some(cell => (cell+"").toLowerCase().includes(globalQ));
        });
      }
      
      // ุชุทุจูู ุงูููุงุชุฑ ุงููุดุทุฉ
      activeFilters.forEach(filter => {
        filteredRows = filteredRows.filter(row => {
          const cellValue = row[filter.column] || "";
          const searchValue = filter.value.toLowerCase();
          
          switch(filter.condition) {
            case "contains":
              return cellValue.toLowerCase().includes(searchValue);
            case "equals":
              return cellValue.toLowerCase() === searchValue;
            case "startsWith":
              return cellValue.toLowerCase().startsWith(searchValue);
            case "endsWith":
              return cellValue.toLowerCase().endsWith(searchValue);
            case "greater":
              const numValue = toNumber(cellValue);
              const numSearch = toNumber(filter.value);
              return !isNaN(numValue) && !isNaN(numSearch) && numValue > numSearch;
            case "less":
              const numValueL = toNumber(cellValue);
              const numSearchL = toNumber(filter.value);
              return !isNaN(numValueL) && !isNaN(numSearchL) && numValueL < numSearchL;
            default:
              return true;
          }
        });
      });
      
      // ุชุทุจูู ููุงุชุฑ ุงูุชุงุฑูุฎ ุฅุฐุง ูุงูุช ูุญุฏุฏุฉ
      const dateFrom = document.getElementById("dateFrom").value;
      const dateTo = document.getElementById("dateTo").value;
      
      if (dateFrom || dateTo) {
        filteredRows = filteredRows.filter(row => {
          const dateStr = row[4] || ""; // ุงูุนููุฏ ุงูุฑุงุจุน ูู ุงูุชุงุฑูุฎ
          const date = toDate(dateStr);
          if (!date) return false;
          
          const fromDate = dateFrom ? new Date(dateFrom) : null;
          const toDateObj = dateTo ? new Date(dateTo) : null;
          
          if (fromDate && date < fromDate) return false;
          if (toDateObj && date > toDateObj) return false;
          
          return true;
        });
      }
      
      // ุชุทุจูู ููุงุชุฑ ุงููููุฉ ุฅุฐุง ูุงูุช ูุญุฏุฏุฉ
      const valueMin = document.getElementById("valueMin").value;
      const valueMax = document.getElementById("valueMax").value;
      
      if (valueMin || valueMax) {
        filteredRows = filteredRows.filter(row => {
          const valueStr = row[2] || ""; // ุงูุนููุฏ ุงูุซุงูู ูู ูููุฉ ุงูุชูููู
          const value = toNumber(valueStr);
          if (isNaN(value)) return false;
          
          const min = valueMin ? parseFloat(valueMin) : -Infinity;
          const max = valueMax ? parseFloat(valueMax) : Infinity;
          
          return value >= min && value <= max;
        });
      }
      
      displayRows = filteredRows;
      
      // ูุฑุฒ ุฐูู
      if (sortState.col !== null){
        const col = sortState.col;
        const dir = sortState.dir === "asc" ? 1 : -1;
        displayRows.sort((a,b) => {
          return smartCompare(a[col] || "", b[col] || "") * dir;
        });
      }
      
      renderTable(displayRows);
      
      // ุฅุฎูุงุก ูุคุดุฑ ุงูุชุญููู
      document.getElementById("loading").classList.remove("show");
    }, 50);
  }

  /***************** ุฅุฏุงุฑุฉ ุงูููุงุชุฑ ุงููุดุทุฉ *****************/
  function addFilter() {
    const column = document.getElementById("columnFilter").value;
    const value = document.getElementById("columnSearch").value.trim();
    const condition = document.getElementById("filterCondition").value;
    
    if (!value) return;
    
    // ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ูุฐุง ุงูููุชุฑ ูุณุจูุงู
    const filterExists = activeFilters.some(f => 
      f.column === column && f.value === value && f.condition === condition
    );
    
    if (filterExists) return;
    
    // ุฅุถุงูุฉ ุงูููุชุฑ ุงูุฌุฏูุฏ
    activeFilters.push({
      column: column === "all" ? "all" : parseInt(column),
      value: value,
      condition: condition
    });
    
    // ุชุญุฏูุซ ูุงุฌูุฉ ุงูููุงุชุฑ ุงููุดุทุฉ
    updateFilterTags();
    
    // ุชุทุจูู ุงูููุงุชุฑ
    applyFiltersAndSort();
  }
  
  function removeFilter(index) {
    activeFilters.splice(index, 1);
    updateFilterTags();
    applyFiltersAndSort();
  }
  
  function updateFilterTags() {
    const container = document.getElementById("filterTags");
    container.innerHTML = "";
    
    activeFilters.forEach((filter, index) => {
      const tag = document.createElement("div");
      tag.className = "filter-tag";
      
      let columnName = "ูู ุงูุฃุนูุฏุฉ";
      if (filter.column !== "all") {
        const columnHeader = document.querySelector(`th[data-col="${filter.column}"]`);
        columnName = columnHeader ? columnHeader.textContent.split(' ')[0] : `ุงูุนููุฏ ${filter.column}`;
      }
      
      let conditionText = "";
      switch(filter.condition) {
        case "contains": conditionText = "ูุญุชูู"; break;
        case "equals": conditionText = "ูุณุงูู"; break;
        case "startsWith": conditionText = "ูุจุฏุฃ ุจู"; break;
        case "endsWith": conditionText = "ููุชูู ุจู"; break;
        case "greater": conditionText = "ุฃูุจุฑ ูู"; break;
        case "less": conditionText = "ุฃูู ูู"; break;
      }
      
      tag.innerHTML = `
        ${columnName} ${conditionText} "${filter.value}"
        <button type="button" onclick="removeFilter(${index})">ร</button>
      `;
      
      container.appendChild(tag);
    });
  }

  /***************** ุฅุนุฏุงุฏ ุชูุงุนูุงุช ุงููุงุฌูุฉ *****************/
  function setupUI(){
    // ุงูุจุญุซ ุงูุนุงู ูุน debounce
    document.getElementById("globalSearch").addEventListener("input", () => {
      clearTimeout(searchDebounce);
      searchDebounce = setTimeout(() => applyFiltersAndSort(), 300);
    });
    
    // ุฅุถุงูุฉ ููุชุฑ
    document.getElementById("addFilterBtn").addEventListener("click", addFilter);
    
    // ุฅุฏุฎุงู ูุต ุงูุจุญุซ ูุน debounce
    document.getElementById("columnSearch").addEventListener("input", () => {
      clearTimeout(searchDebounce);
      searchDebounce = setTimeout(() => applyFiltersAndSort(), 300);
    });
    
    // ุฅุนุงุฏุฉ ุชุนููู
    document.getElementById("resetBtn").addEventListener("click", () => {
      document.getElementById("globalSearch").value = "";
      document.getElementById("columnSearch").value = "";
      document.getElementById("dateFrom").value = "";
      document.getElementById("dateTo").value = "";
      document.getElementById("valueMin").value = "";
      document.getElementById("valueMax").value = "";
      activeFilters = [];
      sortState = { col: null, dir: null };
      
      // ุฅุฒุงูุฉ ูุคุดุฑุงุช ุงููุฑุฒ
      for (let i=0;i<7;i++) document.getElementById("sort-"+i).textContent = "";
      
      updateFilterTags();
      applyFiltersAndSort();
    });
    
    // ุฅุธูุงุฑ/ุฅุฎูุงุก ุงูููุงุชุฑ ุงููุชูุฏูุฉ
    document.getElementById("toggleFilters").addEventListener("click", () => {
      document.getElementById("advancedFilters").classList.toggle("show");
    });
    
    // ุงูููุงุชุฑ ุงููุชูุฏูุฉ
    document.getElementById("dateFrom").addEventListener("change", () => applyFiltersAndSort());
    document.getElementById("dateTo").addEventListener("change", () => applyFiltersAndSort());
    document.getElementById("valueMin").addEventListener("input", () => {
      clearTimeout(searchDebounce);
      searchDebounce = setTimeout(() => applyFiltersAndSort(), 300);
    });
    document.getElementById("valueMax").addEventListener("input", () => {
      clearTimeout(searchDebounce);
      searchDebounce = setTimeout(() => applyFiltersAndSort(), 300);
    });

    // ูุฑุฒ ุนูุฏ ุงูุถุบุท ุนูู ุฑุคูุณ ุงูุฃุนูุฏุฉ
    document.querySelectorAll("#dataTable thead th").forEach(th => {
      th.addEventListener("click", () => {
        const col = parseInt(th.dataset.col,10);
        if (sortState.col === col){
          // ุชุจุฏูู ุงูุงุชุฌุงู
          sortState.dir = sortState.dir === "asc" ? "desc" : "asc";
        } else {
          sortState.col = col;
          sortState.dir = "asc";
        }
        // ุชุญุฏูุซ ูุคุดุฑุงุช ุงูุนุฑุถ ูููุฑุฒ
        for (let i=0;i<7;i++){
          const el = document.getElementById("sort-"+i);
          if (i === sortState.col) el.textContent = (sortState.dir === "asc" ? "โฒ" : "โผ");
          else el.textContent = "";
        }
        applyFiltersAndSort();
      });
    });

    // ุฒุฑ ุงูุชุตุฏูุฑ (ุชุตุฏูุฑ ุงููุชุงุฆุฌ ุงููุฑุดุญุฉ ููุท)
    document.getElementById("exportBtn").addEventListener("click", () => {
      if (!displayRows || displayRows.length === 0){
        alert("ูุง ุชูุฌุฏ ุจูุงูุงุช ููุชุตุฏูุฑ.");
        return;
      }
      // ุชุดููู CSV ูู displayRows
      const header = ["ุงุณู ุงููููู","ุจูุงู ุงูุนูู","ูููุฉ ุงูุชูููู","ุฑูู ุงูุชูููู","ุงูุชุงุฑูุฎ","ูููุน ุงูุนูู","ุงููุฏุฉ"];
      const lines = [header.map(escapeCSV).join(",")];
      displayRows.forEach(r => {
        const line = [];
        for (let i=0;i<7;i++) line.push(escapeCSV(r[i] || ""));
        lines.push(line.join(","));
      });
      const csvContent = lines.join("\r\n");
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'taklef_export.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });
  }

  function escapeCSV(val){
    if (val == null) return "";
    const s = val.toString();
    if (s.includes(',') || s.includes('"') || s.includes('\n') || s.includes('\r')) {
      return '"' + s.replace(/"/g,'""') + '"';
    }
    return s;
  }

  /***************** ุชุญููู ุงูุจูุงูุงุช ูู Google Sheets CSV *****************/
  async function loadDataFromCSV(){
    try {
      document.getElementById("loading").classList.add("show");
      const resp = await fetch(SHEET_CSV_URL);
      if (!resp.ok) throw new Error("ูุดู ุฌูุจ ุงูููู: " + resp.status);
      const text = await resp.text();
      const parsed = parseCSV(text);

      if (parsed.length === 0){
        alert("ุงูููู ูุงุฑุบ ุฃู ูู ูุชููู ุงููุชุตูุญ ูู ูุฑุงุกุชู.");
        return;
      }

      // ููุชุฑุถ ุฃู ุงูุณุทุฑ ุงูุฃูู ูู ุงูุนูุงููู โ ูุฃุฎุฐ ุงูุจุงูู ูุจูุงูุงุช
      originalRows = parsed.slice(1).map(r => {
        // ุถูุงู ูุฌูุฏ 7 ุฃุนูุฏุฉ ุนูู ุงูุฃูู
        const row = [];
        for (let i=0;i<7;i++) row[i] = (r[i] !== undefined) ? r[i] : "";
        return row;
      }).filter(r => r.some(c => c !== "")); // ุฅุฒุงูุฉ ุงูุตููู ุงููุงุฑุบุฉ

      // ุนุฑุถ ุฃููู
      setupUI();
      applyFiltersAndSort();
      document.getElementById("loading").classList.remove("show");
    } catch (err) {
      console.error(err);
      alert("ุญุฏุซ ุฎุทุฃ ุนูุฏ ุชุญููู ุงูุจูุงูุงุช: " + err.message);
    }
  }

  // ุจุฏุก ุงูุชุญููู ุนูุฏ ูุชุญ ุงูุตูุญุฉ
  loadDataFromCSV();
  </script>
</body>
</html>