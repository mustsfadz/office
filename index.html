<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø§Ù„ØªÙƒÙ„ÙŠÙØ§Øª ÙˆØ§Ù„Ù…Ø­Ø§Ø¶Ø± â€” Ø¹Ø±Ø¶ Ø¨Ø§Ù„ÙØªØ±Ø©</title>
  <style>
    :root{
      --main:#0d6efd;
      --bg:#f4f6f9;
      --card:#ffffff;
      --muted:#6c757d;
    }
    /* ØµÙØ­Ø© Ø¹Ø§Ù…Ø© */
    body{
      font-family: "Cairo", Tahoma, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg);
      margin:0;
      padding:18px;
      color:#222;
    }
    .container{ max-width:1200px; margin:0 auto; }
    header{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:14px; flex-wrap:wrap; }
    h1{font-size:20px;margin:0}
    .muted{ color:var(--muted); font-size:13px }

    /* Ø£Ø²Ø±Ø§Ø± ÙˆØªØ­ÙƒÙ…Ø§Øª */
    .controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    button{
      padding:8px 12px;
      border-radius:8px;
      border:0;
      background:var(--main);
      color:#fff;
      cursor:pointer;
    }
    button.secondary{ background:#6c757d; }
    button.ghost{ background:transparent; color:var(--main); border:1px solid rgba(13,110,253,0.12); }

    /* Ø§Ù„ÙÙ„Ø§ØªØ± */
    .filter-section{
      background:#f8f9fa;
      padding:10px;
      border-radius:8px;
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    label{ font-size:13px; color:var(--muted); }
    select, input[type="date"]{ padding:8px 10px; border-radius:8px; border:1px solid #ddd; }

    /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
    .table-card{
      background:var(--card);
      padding:12px;
      border-radius:10px;
      box-shadow:0 4px 12px rgba(0,0,0,0.06);
    }
    table{ width:100%; border-collapse:collapse; direction:rtl; table-layout:fixed; word-wrap:break-word; }
    th, td{ padding:10px 8px; border-bottom:1px solid #eee; text-align:right; vertical-align:middle; font-size:14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    thead th{ cursor:pointer; user-select:none; background:#fafcff; }
    thead th .sort-ind{ margin-left:8px; opacity:0.7; }
    tbody tr:nth-child(even){ background:#fbfbfd; }
    tbody tr:hover{ background:rgba(13,110,253,0.04); }

    /* Ø®Ø·ÙˆØ· Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø­Ø¯ÙŠØ«Ø© */
    /* Ù†Ø·Ø¨Ù‚ Ø®Ø· Ø¹ØµØ±ÙŠ ÙˆÙ†Ù…Ø· Ø£Ø±Ù‚Ø§Ù… tabular Ù„Ù„Ø£Ø¹Ù…Ø¯Ø©: Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙƒÙ„ÙŠÙ (3)ØŒ Ø±Ù‚Ù… Ø§Ù„ØªÙƒÙ„ÙŠÙ (4)ØŒ Ø§Ù„Ù…Ø¯Ø© (7) */
    td:nth-child(3), td:nth-child(4), td:nth-child(7){
      font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      font-variant-numeric: tabular-nums;
    }

    .loading{ display:none; text-align:center; padding:12px; }
    .loading.show{ display:block; }
    .no-results{ text-align:center; padding:30px; color:var(--muted); }

    @media (max-width:880px){
      th, td{ font-size:13px; padding:8px 6px; }
      header{ flex-direction:column; align-items:flex-start; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>ğŸ“Œ Ø§Ù„ØªÙƒÙ„ÙŠÙØ§Øª ÙˆØ§Ù„Ù…Ø­Ø§Ø¶Ø±</h1>
        <div class="muted">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ ÙÙŠ Google Sheets Ù‡Ùˆ Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© â€” Ø§Ù„Ø¹Ø±Ø¶ ÙŠØ¸Ù‡Ø± Ø§Ù„Ù‚ÙŠÙ… ÙƒÙ…Ø§ Ù‡ÙŠ (Ø§Ù„ØªØ§Ø±ÙŠØ® Ø³ÙŠÙØ¹Ø±Ø¶ ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ø´ÙŠØª).</div>
      </div>

      <div class="controls">
        <button id="refreshBtn" title="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <button id="clearPeriod" class="secondary" title="Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙƒÙ„</button>
        <div id="lastUpdated" class="muted" style="min-width:160px; text-align:left;"></div>
      </div>
    </header>

    <div class="filter-section" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØªØ±Ø©">
      <div>
        <label for="presetRange">Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</label><br>
        <select id="presetRange" title="Ø§Ø®ØªØ± ÙØªØ±Ø© Ø³Ø±ÙŠØ¹Ø©">
          <option value="all">ÙƒÙ„ Ø§Ù„ÙØªØ±Ø§Øª</option>
          <option value="7">Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</option>
          <option value="30">Ø¢Ø®Ø± 30 ÙŠÙˆÙ…</option>
          <option value="thisMonth">Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</option>
          <option value="lastMonth">Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ</option>
          <option value="custom">ØªØ­Ø¯ÙŠØ¯ ÙŠØ¯ÙˆÙŠ</option>
        </select>
      </div>

      <div id="customDates" style="display:none;">
        <label>Ù…Ù† â€” Ø¥Ù„Ù‰</label><br>
        <input id="dateFrom" type="date"> &nbsp; <input id="dateTo" type="date">
      </div>

      <div style="margin-left:auto;">
        <label>&nbsp;</label><br>
        <button id="applyPeriod" class="ghost">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙØªØ±Ø©</button>
      </div>
    </div>

    <div class="table-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;">
        <div class="muted small">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙˆØ¯ Ù„Ù„ÙØ±Ø² (ØµØ¹ÙˆØ¯ / Ù‡Ø¨ÙˆØ·). Ø§Ù„ØªØµÙÙŠØ© Ù‡Ù†Ø§ Ø­Ø³Ø¨ Ø§Ù„ÙØªØ±Ø© ÙÙ‚Ø·.</div>
      </div>

      <div id="loading" class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>

      <table id="dataTable" aria-describedby="Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙƒÙ„ÙŠÙØ§Øª">
        <thead>
          <tr>
            <th data-col="0">Ø§Ø³Ù… Ø§Ù„Ù…ÙƒÙ„Ù <span class="sort-ind" id="sort-0"></span></th>
            <th data-col="1">Ø¨ÙŠØ§Ù† Ø§Ù„Ø¹Ù…Ù„ <span class="sort-ind" id="sort-1"></span></th>
            <th data-col="2">Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙƒÙ„ÙŠÙ <span class="sort-ind" id="sort-2"></span></th>
            <th data-col="3">Ø±Ù‚Ù… Ø§Ù„ØªÙƒÙ„ÙŠÙ <span class="sort-ind" id="sort-3"></span></th>
            <th data-col="4">Ø§Ù„ØªØ§Ø±ÙŠØ® <span class="sort-ind" id="sort-4"></span></th>
            <th data-col="5">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„ <span class="sort-ind" id="sort-5"></span></th>
            <th data-col="6">Ø§Ù„Ù…Ø¯Ø© <span class="sort-ind" id="sort-6"></span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="noResults" class="no-results" style="display:none">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¬Ù„Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</div>
      <div id="info" class="muted" style="margin-top:10px"></div>
    </div>
  </div>

  <script>
    /****************************************************************
     * Ø±Ø§Ø¨Ø· CSV Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ù…Ù† Google Sheets
     ****************************************************************/
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSv-LIrm2oZEBfHK9hMt7Bz5HYJbW1n0aInzh-i0g9agDKrKyNbyYkshaV1GMgcnn8oGVO5OeIYlKRS/pub?gid=0&single=true&output=csv";

    let originalRows = [];
    let displayRows = [];
    let sortState = { col: null, dir: null };
    const loadingEl = document.getElementById("loading");
    const lastUpdatedEl = document.getElementById("lastUpdated");

    // CSV parser Ø¨Ø³ÙŠØ· ÙŠØ¯Ø¹Ù… Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³Ø§Øª ÙˆØ§Ù„commas Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„
    function parseCSV(text){
      const rows = [];
      let cur = '';
      let row = [];
      let inQuotes = false;
      for (let i=0;i<text.length;i++){
        const ch = text[i];
        const next = text[i+1];
        if (ch === '"' ) {
          if (inQuotes && next === '"') {
            cur += '"'; i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (ch === ',' && !inQuotes){
          row.push(cur); cur = '';
        } else if ((ch === '\n' || ch === '\r') && !inQuotes){
          if (ch === '\r' && text[i+1] === '\n') { /* skip */ }
          if (cur !== '' || row.length>0) {
            row.push(cur);
            rows.push(row);
            row = []; cur = '';
          }
        } else {
          cur += ch;
        }
      }
      if (cur !== '' || row.length>0) {
        row.push(cur);
        rows.push(row);
      }
      return rows.map(r => r.map(c => c.trim())).filter(r => r.some(cell => cell !== ""));
    }

    // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­ÙˆÙŠÙ„ Ù†Øµ Ø¥Ù„Ù‰ Ø±Ù‚Ù…
    function toNumber(value){
      if (value == null) return NaN;
      const cleaned = value.toString().replace(/[^0-9.\-\/]/g,'').replace(/,+/g,'');
      const n = parseFloat(cleaned);
      return isNaN(n) ? NaN : n;
    }

    // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­ÙˆÙŠÙ„ Ù†Øµ Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ù…ÙŠÙ„Ø§Ø¯ÙŠ (ÙŠØ¯Ø¹Ù… yyyy-mm-dd Ùˆ dd/mm/yyyy Ùˆ dd-mm-yyyy)
    function toDate(value){
      if (!value) return null;
      const v = value.toString().trim();
      const iso = /^\d{4}-\d{1,2}-\d{1,2}$/;
      const dmy = /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/;
      if (iso.test(v)){
        const d = new Date(v);
        return isNaN(d.getTime()) ? null : d;
      }
      const m = v.match(dmy);
      if (m){
        let day = parseInt(m[1],10), month = parseInt(m[2],10), year = parseInt(m[3],10);
        if (year < 100) year += 2000;
        const d = new Date(year, month-1, day);
        return isNaN(d.getTime()) ? null : d;
      }
      const tryDate = new Date(v);
      return isNaN(tryDate.getTime()) ? null : tryDate;
    }

    // Ù…Ù‚Ø§Ø±Ù†Ø© Ø°ÙƒÙŠØ© (ØªØ³ØªØ®Ø¯Ù… Ù„Ù„ÙØ±Ø²)
    function smartCompare(a,b){
      if ((a==null || a==="") && (b==null || b==="")) return 0;
      if (a==null || a==="") return -1;
      if (b==null || b==="") return 1;
      const da = toDate(a), db = toDate(b);
      if (da && db) return da - db;
      const na = toNumber(a), nb = toNumber(b);
      if (!isNaN(na) && !isNaN(nb)) return na - nb;
      return a.toString().localeCompare(b.toString(),'ar');
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù…Ù† CSV Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙƒÙ…Ø§ Ù‡Ùˆ)
    function renderTable(rows){
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";
      if (rows.length === 0) {
        document.getElementById("noResults").style.display = "block";
      } else {
        document.getElementById("noResults").style.display = "none";
        rows.forEach(r => {
          const tr = document.createElement("tr");
          for (let c=0;c<7;c++){
            const td = document.createElement("td");
            td.textContent = r[c] ?? "";
            tr.appendChild(td);
          }
          tbody.appendChild(tr);
        });
      }
      document.getElementById("info").textContent = `Ø¹Ø±Ø¶ ${rows.length} Ù†ØªÙŠØ¬Ø© Ù…Ù† ${originalRows.length} Ø³Ø¬Ù„`;
    }

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØªØ±Ø© ÙˆØ§Ù„ÙØ±Ø²
    function applyPeriodAndSort(){
      loadingEl.classList.add("show");
      setTimeout(() => {
        let rows = originalRows.slice();

        // Ø§Ø­ØµÙ„ Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¥Ù† ØªÙ… Ø§Ø®ØªÙŠØ§Ø± "custom" Ø£Ùˆ Ù…Ù† preset
        const preset = document.getElementById("presetRange").value;
        let from = null, to = null;
        const today = new Date();
        if (preset === "all"){
          from = null; to = null;
        } else if (preset === "7"){
          to = new Date(); from = new Date(); from.setDate(today.getDate()-6);
        } else if (preset === "30"){
          to = new Date(); from = new Date(); from.setDate(today.getDate()-29);
        } else if (preset === "thisMonth"){
          from = new Date(today.getFullYear(), today.getMonth(), 1);
          to = new Date(today.getFullYear(), today.getMonth()+1, 0); to.setHours(23,59,59,999);
        } else if (preset === "lastMonth"){
          const m = new Date(today.getFullYear(), today.getMonth()-1, 1);
          from = new Date(m.getFullYear(), m.getMonth(), 1);
          to = new Date(m.getFullYear(), m.getMonth()+1, 0); to.setHours(23,59,59,999);
        } else if (preset === "custom"){
          const d1 = document.getElementById("dateFrom").value;
          const d2 = document.getElementById("dateTo").value;
          if (d1) from = new Date(d1);
          if (d2) { to = new Date(d2); to.setHours(23,59,59,999); }
        }

        // Ø¥Ø°Ø§ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù†Ø·Ø§Ù‚ ÙØ¹Ù„ÙŠÙ‹Ø§ØŒ Ø·Ø¨Ù‚ Ø§Ù„ØªØµÙÙŠØ©
        if (from || to){
          rows = rows.filter(row => {
            const dateStr = row[4] || "";
            const d = toDate(dateStr);
            if (!d) return false; // Ø¥Ø°Ø§ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­ÙˆÙŠÙ„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø®Ù„ÙŠØ© ÙÙ„Ù† ÙŠØ¸Ù‡Ø± Ø¶Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚
            if (from && d < from) return false;
            if (to && d > to) return false;
            return true;
          });
        }

        // Ø§Ù„ÙØ±Ø² Ø­Ø³Ø¨ Ø­Ø§Ù„Ø© sortState Ø¥Ù† ÙˆØ¬Ø¯Øª
        if (sortState.col !== null){
          const col = sortState.col;
          const dir = sortState.dir === "asc" ? 1 : -1;
          rows.sort((a,b) => smartCompare(a[col]||"", b[col]||"") * dir);
        }

        displayRows = rows;
        renderTable(displayRows);
        loadingEl.classList.remove("show");
      }, 30);
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† CSV (ÙŠÙˆØ¬Ø¯ Ø²Ø± ØªØ­Ø¯ÙŠØ« ÙŠØ¬Ù„Ø¨ Ù…Ø¹ cache:no-store)
    async function loadDataFromCSV(force=false){
      try {
        loadingEl.classList.add("show");
        const resp = await fetch(SHEET_CSV_URL, { cache: "no-store" });
        if (!resp.ok) throw new Error("ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù„Ù: " + resp.status);
        const text = await resp.text();
        const parsed = parseCSV(text);
        if (parsed.length === 0) {
          alert("Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù† Ù‚Ø±Ø§Ø¡ØªÙ‡.");
          loadingEl.classList.remove("show");
          return;
        }
        // Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø£ÙˆÙ„ Ù‡Ùˆ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
        originalRows = parsed.slice(1).map(r => {
          const row = [];
          for (let i=0;i<7;i++) row[i] = (r[i] !== undefined) ? r[i] : "";
          return row;
        }).filter(r => r.some(c => c !== ""));
        const now = new Date();
        lastUpdatedEl.textContent = "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: " + now.toLocaleString('ar-EG');
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø­Ø³Ø¨ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
        applyPeriodAndSort();
        loadingEl.classList.remove("show");
      } catch (err){
        console.error(err);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + err.message);
        loadingEl.classList.remove("show");
      }
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
    function setupUI(){
      // ØªØºÙŠÙŠØ± preset Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø®ØµØµØ© Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
      document.getElementById("presetRange").addEventListener("change", (e) => {
        const v = e.target.value;
        document.getElementById("customDates").style.display = (v === "custom") ? "block" : "none";
      });

      document.getElementById("applyPeriod").addEventListener("click", applyPeriodAndSort);

      document.getElementById("refreshBtn").addEventListener("click", () => loadDataFromCSV(true));

      document.getElementById("clearPeriod").addEventListener("click", () => {
        document.getElementById("presetRange").value = "all";
        document.getElementById("customDates").style.display = "none";
        document.getElementById("dateFrom").value = "";
        document.getElementById("dateTo").value = "";
        applyPeriodAndSort();
      });

      // ÙØ±Ø² Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
      document.querySelectorAll("#dataTable thead th").forEach(th => {
        th.addEventListener("click", () => {
          const col = parseInt(th.dataset.col,10);
          if (sortState.col === col){
            sortState.dir = sortState.dir === "asc" ? "desc" : "asc";
          } else {
            sortState.col = col; sortState.dir = "asc";
          }
          for (let i=0;i<7;i++){
            const el = document.getElementById("sort-"+i);
            el.textContent = (i === sortState.col) ? (sortState.dir === "asc" ? "â–²" : "â–¼") : "";
          }
          applyPeriodAndSort();
        });
      });
    }

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„ØªÙ‡ÙŠØ¦Ø©
    setupUI();
    loadDataFromCSV();
  </script>
</body>
</html>
