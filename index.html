<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>التكليفات والمحاضر — عرض بالفترة</title>
  <style>
    :root{
      --main:#0d6efd;
      --bg:#f4f6f9;
      --card:#ffffff;
      --muted:#6c757d;
    }
    /* صفحة عامة */
    body{
      font-family: "Cairo", Tahoma, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg);
      margin:0;
      padding:18px;
      color:#222;
    }
    .container{ max-width:1200px; margin:0 auto; }
    header{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:14px; flex-wrap:wrap; }
    h1{font-size:20px;margin:0}
    .muted{ color:var(--muted); font-size:13px }

    /* أزرار وتحكمات */
    .controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    button{
      padding:8px 12px;
      border-radius:8px;
      border:0;
      background:var(--main);
      color:#fff;
      cursor:pointer;
    }
    button.secondary{ background:#6c757d; }
    button.ghost{ background:transparent; color:var(--main); border:1px solid rgba(13,110,253,0.12); }

    /* الفلاتر */
    .filter-section{
      background:#f8f9fa;
      padding:10px;
      border-radius:8px;
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    label{ font-size:13px; color:var(--muted); }
    select, input[type="date"]{ padding:8px 10px; border-radius:8px; border:1px solid #ddd; }

    /* الجدول */
    .table-card{
      background:var(--card);
      padding:12px;
      border-radius:10px;
      box-shadow:0 4px 12px rgba(0,0,0,0.06);
    }
    table{ width:100%; border-collapse:collapse; direction:rtl; table-layout:fixed; word-wrap:break-word; }
    th, td{ padding:10px 8px; border-bottom:1px solid #eee; text-align:right; vertical-align:middle; font-size:14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    thead th{ cursor:pointer; user-select:none; background:#fafcff; }
    thead th .sort-ind{ margin-left:8px; opacity:0.7; }
    tbody tr:nth-child(even){ background:#fbfbfd; }
    tbody tr:hover{ background:rgba(13,110,253,0.04); }

    /* خطوط الأرقام الحديثة */
    /* نطبق خط عصري ونمط أرقام tabular للأعمدة: قيمة التكليف (3)، رقم التكليف (4)، المدة (7) */
    td:nth-child(3), td:nth-child(4), td:nth-child(7){
      font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      font-variant-numeric: tabular-nums;
    }

    .loading{ display:none; text-align:center; padding:12px; }
    .loading.show{ display:block; }
    .no-results{ text-align:center; padding:30px; color:var(--muted); }

    @media (max-width:880px){
      th, td{ font-size:13px; padding:8px 6px; }
      header{ flex-direction:column; align-items:flex-start; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>📌 التكليفات والمحاضر</h1>
        <div class="muted">الصف الأول في Google Sheets هو عناوين الأعمدة — العرض يظهر القيم كما هي (التاريخ سيُعرض كما في الشيت).</div>
      </div>

      <div class="controls">
        <button id="refreshBtn" title="تحديث البيانات">🔄 تحديث البيانات</button>
        <button id="clearPeriod" class="secondary" title="عرض كل السجلات">إظهار الكل</button>
        <div id="lastUpdated" class="muted" style="min-width:160px; text-align:left;"></div>
      </div>
    </header>

    <div class="filter-section" aria-label="اختيار الفترة">
      <div>
        <label for="presetRange">الفترة السريعة</label><br>
        <select id="presetRange" title="اختر فترة سريعة">
          <option value="all">كل الفترات</option>
          <option value="7">آخر 7 أيام</option>
          <option value="30">آخر 30 يوم</option>
          <option value="thisMonth">الشهر الحالي</option>
          <option value="lastMonth">الشهر الماضي</option>
          <option value="custom">تحديد يدوي</option>
        </select>
      </div>

      <div id="customDates" style="display:none;">
        <label>من — إلى</label><br>
        <input id="dateFrom" type="date"> &nbsp; <input id="dateTo" type="date">
      </div>

      <div style="margin-left:auto;">
        <label>&nbsp;</label><br>
        <button id="applyPeriod" class="ghost">تطبيق الفترة</button>
      </div>
    </div>

    <div class="table-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;">
        <div class="muted small">انقر على عنوان العمود للفرز (صعود / هبوط). التصفية هنا حسب الفترة فقط.</div>
      </div>

      <div id="loading" class="loading">جاري تحميل البيانات...</div>

      <table id="dataTable" aria-describedby="جدول التكليفات">
        <thead>
          <tr>
            <th data-col="0">اسم المكلف <span class="sort-ind" id="sort-0"></span></th>
            <th data-col="1">بيان العمل <span class="sort-ind" id="sort-1"></span></th>
            <th data-col="2">قيمة التكليف <span class="sort-ind" id="sort-2"></span></th>
            <th data-col="3">رقم التكليف <span class="sort-ind" id="sort-3"></span></th>
            <th data-col="4">التاريخ <span class="sort-ind" id="sort-4"></span></th>
            <th data-col="5">موقع العمل <span class="sort-ind" id="sort-5"></span></th>
            <th data-col="6">المدة <span class="sort-ind" id="sort-6"></span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="noResults" class="no-results" style="display:none">لم يتم العثور على سجلات في هذه الفترة</div>
      <div id="info" class="muted" style="margin-top:10px"></div>
    </div>
  </div>

  <script>
    /****************************************************************
     * رابط CSV المنشور من Google Sheets
     ****************************************************************/
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSv-LIrm2oZEBfHK9hMt7Bz5HYJbW1n0aInzh-i0g9agDKrKyNbyYkshaV1GMgcnn8oGVO5OeIYlKRS/pub?gid=0&single=true&output=csv";

    let originalRows = [];
    let displayRows = [];
    let sortState = { col: null, dir: null };
    const loadingEl = document.getElementById("loading");
    const lastUpdatedEl = document.getElementById("lastUpdated");

    // CSV parser بسيط يدعم الاقتباسات والcommas داخل الحقول
    function parseCSV(text){
      const rows = [];
      let cur = '';
      let row = [];
      let inQuotes = false;
      for (let i=0;i<text.length;i++){
        const ch = text[i];
        const next = text[i+1];
        if (ch === '"' ) {
          if (inQuotes && next === '"') {
            cur += '"'; i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (ch === ',' && !inQuotes){
          row.push(cur); cur = '';
        } else if ((ch === '\n' || ch === '\r') && !inQuotes){
          if (ch === '\r' && text[i+1] === '\n') { /* skip */ }
          if (cur !== '' || row.length>0) {
            row.push(cur);
            rows.push(row);
            row = []; cur = '';
          }
        } else {
          cur += ch;
        }
      }
      if (cur !== '' || row.length>0) {
        row.push(cur);
        rows.push(row);
      }
      return rows.map(r => r.map(c => c.trim())).filter(r => r.some(cell => cell !== ""));
    }

    // محاولة تحويل نص إلى رقم
    function toNumber(value){
      if (value == null) return NaN;
      const cleaned = value.toString().replace(/[^0-9.\-\/]/g,'').replace(/,+/g,'');
      const n = parseFloat(cleaned);
      return isNaN(n) ? NaN : n;
    }

    // محاولة تحويل نص إلى تاريخ ميلادي (يدعم yyyy-mm-dd و dd/mm/yyyy و dd-mm-yyyy)
    function toDate(value){
      if (!value) return null;
      const v = value.toString().trim();
      const iso = /^\d{4}-\d{1,2}-\d{1,2}$/;
      const dmy = /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/;
      if (iso.test(v)){
        const d = new Date(v);
        return isNaN(d.getTime()) ? null : d;
      }
      const m = v.match(dmy);
      if (m){
        let day = parseInt(m[1],10), month = parseInt(m[2],10), year = parseInt(m[3],10);
        if (year < 100) year += 2000;
        const d = new Date(year, month-1, day);
        return isNaN(d.getTime()) ? null : d;
      }
      const tryDate = new Date(v);
      return isNaN(tryDate.getTime()) ? null : tryDate;
    }

    // مقارنة ذكية (تستخدم للفرز)
    function smartCompare(a,b){
      if ((a==null || a==="") && (b==null || b==="")) return 0;
      if (a==null || a==="") return -1;
      if (b==null || b==="") return 1;
      const da = toDate(a), db = toDate(b);
      if (da && db) return da - db;
      const na = toNumber(a), nb = toNumber(b);
      if (!isNaN(na) && !isNaN(nb)) return na - nb;
      return a.toString().localeCompare(b.toString(),'ar');
    }

    // عرض الجدول (نستخدم القيم الأصلية من CSV لعرض التاريخ كما هو)
    function renderTable(rows){
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";
      if (rows.length === 0) {
        document.getElementById("noResults").style.display = "block";
      } else {
        document.getElementById("noResults").style.display = "none";
        rows.forEach(r => {
          const tr = document.createElement("tr");
          for (let c=0;c<7;c++){
            const td = document.createElement("td");
            td.textContent = r[c] ?? "";
            tr.appendChild(td);
          }
          tbody.appendChild(tr);
        });
      }
      document.getElementById("info").textContent = `عرض ${rows.length} نتيجة من ${originalRows.length} سجل`;
    }

    // تطبيق الفلترة حسب الفترة والفرز
    function applyPeriodAndSort(){
      loadingEl.classList.add("show");
      setTimeout(() => {
        let rows = originalRows.slice();

        // احصل نطاق التاريخ من الحقول إن تم اختيار "custom" أو من preset
        const preset = document.getElementById("presetRange").value;
        let from = null, to = null;
        const today = new Date();
        if (preset === "all"){
          from = null; to = null;
        } else if (preset === "7"){
          to = new Date(); from = new Date(); from.setDate(today.getDate()-6);
        } else if (preset === "30"){
          to = new Date(); from = new Date(); from.setDate(today.getDate()-29);
        } else if (preset === "thisMonth"){
          from = new Date(today.getFullYear(), today.getMonth(), 1);
          to = new Date(today.getFullYear(), today.getMonth()+1, 0); to.setHours(23,59,59,999);
        } else if (preset === "lastMonth"){
          const m = new Date(today.getFullYear(), today.getMonth()-1, 1);
          from = new Date(m.getFullYear(), m.getMonth(), 1);
          to = new Date(m.getFullYear(), m.getMonth()+1, 0); to.setHours(23,59,59,999);
        } else if (preset === "custom"){
          const d1 = document.getElementById("dateFrom").value;
          const d2 = document.getElementById("dateTo").value;
          if (d1) from = new Date(d1);
          if (d2) { to = new Date(d2); to.setHours(23,59,59,999); }
        }

        // إذا تم تحديد نطاق فعليًا، طبق التصفية
        if (from || to){
          rows = rows.filter(row => {
            const dateStr = row[4] || "";
            const d = toDate(dateStr);
            if (!d) return false; // إذا لا يمكن تحويل تاريخ الخلية فلن يظهر ضمن النطاق
            if (from && d < from) return false;
            if (to && d > to) return false;
            return true;
          });
        }

        // الفرز حسب حالة sortState إن وجدت
        if (sortState.col !== null){
          const col = sortState.col;
          const dir = sortState.dir === "asc" ? 1 : -1;
          rows.sort((a,b) => smartCompare(a[col]||"", b[col]||"") * dir);
        }

        displayRows = rows;
        renderTable(displayRows);
        loadingEl.classList.remove("show");
      }, 30);
    }

    // تحميل البيانات من CSV (يوجد زر تحديث يجلب مع cache:no-store)
    async function loadDataFromCSV(force=false){
      try {
        loadingEl.classList.add("show");
        const resp = await fetch(SHEET_CSV_URL, { cache: "no-store" });
        if (!resp.ok) throw new Error("فشل جلب الملف: " + resp.status);
        const text = await resp.text();
        const parsed = parseCSV(text);
        if (parsed.length === 0) {
          alert("الملف فارغ أو لم يتمكن المتصفح من قراءته.");
          loadingEl.classList.remove("show");
          return;
        }
        // نفترض أن السطر الأول هو العناوين
        originalRows = parsed.slice(1).map(r => {
          const row = [];
          for (let i=0;i<7;i++) row[i] = (r[i] !== undefined) ? r[i] : "";
          return row;
        }).filter(r => r.some(c => c !== ""));
        const now = new Date();
        lastUpdatedEl.textContent = "آخر تحديث: " + now.toLocaleString('ar-EG');
        // إعادة العرض بحسب الفترة المختارة
        applyPeriodAndSort();
        loadingEl.classList.remove("show");
      } catch (err){
        console.error(err);
        alert("حدث خطأ عند تحميل البيانات: " + err.message);
        loadingEl.classList.remove("show");
      }
    }

    // إعداد التفاعلات
    function setupUI(){
      // تغيير preset لإظهار الحقول المخصصة عند الحاجة
      document.getElementById("presetRange").addEventListener("change", (e) => {
        const v = e.target.value;
        document.getElementById("customDates").style.display = (v === "custom") ? "block" : "none";
      });

      document.getElementById("applyPeriod").addEventListener("click", applyPeriodAndSort);

      document.getElementById("refreshBtn").addEventListener("click", () => loadDataFromCSV(true));

      document.getElementById("clearPeriod").addEventListener("click", () => {
        document.getElementById("presetRange").value = "all";
        document.getElementById("customDates").style.display = "none";
        document.getElementById("dateFrom").value = "";
        document.getElementById("dateTo").value = "";
        applyPeriodAndSort();
      });

      // فرز عند الضغط على رؤوس الأعمدة
      document.querySelectorAll("#dataTable thead th").forEach(th => {
        th.addEventListener("click", () => {
          const col = parseInt(th.dataset.col,10);
          if (sortState.col === col){
            sortState.dir = sortState.dir === "asc" ? "desc" : "asc";
          } else {
            sortState.col = col; sortState.dir = "asc";
          }
          for (let i=0;i<7;i++){
            const el = document.getElementById("sort-"+i);
            el.textContent = (i === sortState.col) ? (sortState.dir === "asc" ? "▲" : "▼") : "";
          }
          applyPeriodAndSort();
        });
      });
    }

    // بدء التحميل والتهيئة
    setupUI();
    loadDataFromCSV();
  </script>
</body>
</html>
