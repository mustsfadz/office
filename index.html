<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø§Ù„ØªÙƒÙ„ÙŠÙØ§Øª ÙˆØ§Ù„Ù…Ø­Ø§Ø¶Ø±</title>
  <style>
    :root{
      --main:#0d6efd;
      --accent:#198754;
      --bg:#f4f6f9;
      --card:#ffffff;
      --muted:#6c757d;
      --error:#dc3545;
      --warning:#ffc107;
    }
    body{
      font-family: "Cairo", Tahoma, sans-serif;
      background: var(--bg);
      margin:0;
      padding:18px;
      color:#222;
    }
    .container{
      max-width:1200px;
      margin:0 auto;
    }
    header{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:14px;
    }
    h1{font-size:20px;margin:0}
    .controls{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    input[type="search"], select {
      padding:8px 10px;
      border-radius:8px;
      border:1px solid #ddd;
      min-width:180px;
    }
    button {
      padding:8px 12px;
      border-radius:8px;
      border:0;
      background:var(--main);
      color:#fff;
      cursor:pointer;
      transition: background 0.2s;
    }
    button:hover {
      background:#0b5ed7;
    }
    button.secondary{
      background:#6c757d;
    }
    button.secondary:hover{
      background:#5c636a;
    }
    .table-card{
      background:var(--card);
      padding:12px;
      border-radius:10px;
      box-shadow:0 4px 12px rgba(0,0,0,0.06);
    }
    table{
      width:100%;
      border-collapse:collapse;
      direction:rtl;
      table-layout:fixed;
      word-wrap:break-word;
    }
    th, td{
      padding:10px 8px;
      border-bottom:1px solid #eee;
      text-align:right;
      vertical-align:middle;
      font-size:14px;
    }
    thead th{
      background:linear-gradient(0deg, rgba(255,255,255,0.02), rgba(255,255,255,0.02));
      position:relative;
      cursor:pointer;
      user-select:none;
    }
    thead th .sort-ind {
      display:inline-block;
      width:10px;
      margin-left:8px;
      opacity:0.7;
    }
    tbody tr:nth-child(even){
      background:#fbfbfd;
    }
    tbody tr:hover {
      background-color: rgba(13, 110, 253, 0.05);
    }
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:13px}
    .actions { display:flex; gap:6px; align-items:center; }
    .filter-section {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .filter-section > div {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .filter-section label {
      font-size: 13px;
      color: var(--muted);
    }
    .advanced-filters {
      display: none;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #eee;
    }
    .advanced-filters.show {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    .toggle-filters {
      background: none;
      border: none;
      color: var(--main);
      cursor: pointer;
      font-size: 13px;
      padding: 5px;
    }
    .filter-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .filter-tag {
      background-color: #e9ecef;
      border-radius: 16px;
      padding: 4px 10px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .filter-tag button {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 0;
      font-size: 14px;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    .filter-tag button:hover {
      background-color: #dee2e6;
    }
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }
    .loading.show {
      display: block;
    }
    .no-results {
      text-align: center;
      padding: 30px;
      color: var(--muted);
    }
    @media (max-width:880px){
      th, td { font-size:13px; padding:8px 6px; }
      header{flex-direction:column;align-items:flex-start;gap:10px}
      .filter-section > div {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>ğŸ“Œ Ø§Ù„ØªÙƒÙ„ÙŠÙØ§Øª ÙˆØ§Ù„Ù…Ø­Ø§Ø¶Ø±</h1>
        <div class="muted small">Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Google Sheets â€” Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ ÙŠØ¹ØªØ¨Ø± Ø¹Ù†Ø§ÙˆÙŠÙ† ÙˆÙ„Ù† ÙŠØ¹Ø±Ø¶ ÙƒØ¨ÙŠØ§Ù†Ø§Øª</div>
      </div>

      <div class="controls">
        <!-- Ø¨Ø­Ø« Ø¹Ø§Ù… -->
        <input id="globalSearch" type="search" placeholder="Ø¨Ø­Ø« Ø¹Ø§Ù…... (Ø§Ø³Ù… Ø§Ù„Ù…ÙƒÙ„ÙØŒ Ø¨ÙŠØ§Ù† Ø§Ù„Ø¹Ù…Ù„ØŒ Ø±Ù‚Ù… ...)">

        <!-- Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† -->
        <button id="resetBtn" class="secondary">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ±</button>
      </div>
    </header>

    <div class="filter-section">
      <div>
        <label for="columnFilter">ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…ÙˆØ¯:</label>
        <select id="columnFilter">
          <option value="all">ÙƒÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©</option>
          <option value="0">Ø§Ø³Ù… Ø§Ù„Ù…ÙƒÙ„Ù</option>
          <option value="1">Ø¨ÙŠØ§Ù† Ø§Ù„Ø¹Ù…Ù„</option>
          <option value="2">Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙƒÙ„ÙŠÙ</option>
          <option value="3">Ø±Ù‚Ù… Ø§Ù„ØªÙƒÙ„ÙŠÙ</option>
          <option value="4">Ø§Ù„ØªØ§Ø±ÙŠØ®</option>
          <option value="5">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„</option>
          <option value="6">Ø§Ù„Ù…Ø¯Ø©</option>
        </select>
      </div>
      
      <div>
        <label for="columnSearch">Ù†Øµ Ø§Ù„Ø¨Ø­Ø«:</label>
        <input id="columnSearch" type="search" placeholder="Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø¨Ø­Ø« Ù‡Ù†Ø§">
      </div>
      
      <div>
        <label for="filterCondition">Ø´Ø±Ø· Ø§Ù„ÙÙ„ØªØ±Ø©:</label>
        <select id="filterCondition">
          <option value="contains">ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰</option>
          <option value="equals">ÙŠØ³Ø§ÙˆÙŠ</option>
          <option value="startsWith">ÙŠØ¨Ø¯Ø£ Ø¨Ù€</option>
          <option value="endsWith">ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€</option>
          <option value="greater">Ø£ÙƒØ¨Ø± Ù…Ù†</option>
          <option value="less">Ø£Ù‚Ù„ Ù…Ù†</option>
        </select>
      </div>
      
      <div>
        <label>&nbsp;</label>
        <button id="addFilterBtn">Ø¥Ø¶Ø§ÙØ© ÙÙ„ØªØ±</button>
      </div>
    </div>
    
    <button id="toggleFilters" class="toggle-filters">+ Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</button>
    
    <div id="advancedFilters" class="advanced-filters">
      <div>
        <label for="dateFrom">Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
        <input id="dateFrom" type="date">
      </div>
      
      <div>
        <label for="dateTo">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
        <input id="dateTo" type="date">
      </div>
      
      <div>
        <label for="valueMin">Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙƒÙ„ÙŠÙ Ù…Ù†:</label>
        <input id="valueMin" type="number" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰">
      </div>
      
      <div>
        <label for="valueMax">Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙƒÙ„ÙŠÙ Ø¥Ù„Ù‰:</label>
        <input id="valueMax" type="number" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰">
      </div>
    </div>
    
    <div id="filterTags" class="filter-tags"></div>

    <div class="table-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:12px;flex-wrap:wrap">
        <div class="small muted">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙˆØ¯ Ù„Ù„ÙØ±Ø² (ØµØ¹ÙˆØ¯ / Ù‡Ø¨ÙˆØ·). Ø§Ù„ÙØ±Ø² ÙŠØªØ¹Ø±Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„ØªÙˆØ§Ø±ÙŠØ®.</div>
        <div class="actions">
          <button id="exportBtn">ØªØµØ¯ÙŠØ± CSV Ù…Ø±Ø´Ø­</button>
        </div>
      </div>

      <div id="loading" class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
      
      <table id="dataTable" aria-describedby="Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙƒÙ„ÙŠÙØ§Øª">
        <thead>
          <tr>
            <th data-col="0">Ø§Ø³Ù… Ø§Ù„Ù…ÙƒÙ„Ù <span class="sort-ind" id="sort-0"></span></th>
            <th data-col="1">Ø¨ÙŠØ§Ù† Ø§Ù„Ø¹Ù…Ù„ <span class="sort-ind" id="sort-1"></span></th>
            <th data-col="2">Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙƒÙ„ÙŠÙ <span class="sort-ind" id="sort-2"></span></th>
            <th data-col="3">Ø±Ù‚Ù… Ø§Ù„ØªÙƒÙ„ÙŠÙ <span class="sort-ind" id="sort-3"></span></th>
            <th data-col="4">Ø§Ù„ØªØ§Ø±ÙŠØ® <span class="sort-ind" id="sort-4"></span></th>
            <th data-col="5">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„ <span class="sort-ind" id="sort-5"></span></th>
            <th data-col="6">Ø§Ù„Ù…Ø¯Ø© <span class="sort-ind" id="sort-6"></span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      
      <div id="noResults" class="no-results" style="display: none;">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ ØªØ·Ø§Ø¨Ù‚ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø«</div>

      <div id="info" class="muted small" style="margin-top:10px"></div>
    </div>
  </div>

  <script>
  /****************************************************************
   * ØªÙƒÙˆÙŠÙ†: Ø¶Ø¹ Ø±Ø§Ø¨Ø· CSV Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ù…Ù† Google Sheets Ù‡Ù†Ø§
   ****************************************************************/
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSv-LIrm2oZEBfHK9hMt7Bz5HYJbW1n0aInzh-i0g9agDKrKyNbyYkshaV1GMgcnn8oGVO5OeIYlKRS/pub?gid=0&single=true&output=csv";

  // Ù…ØµÙÙˆÙØ© Ø£ØµÙ„ÙŠØ© Ù„Ù„ØµÙÙˆÙ (ÙƒÙ„ ØµÙ Ø¹Ø¨Ø§Ø±Ø© Ø¹Ù† Ù…ØµÙÙˆÙØ© Ø£Ø¹Ù…Ø¯Ø©)
  let originalRows = [];
  // Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø©/Ø§Ù„ÙØ±Ø²
  let displayRows = [];
  // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ±Ø² Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  let sortState = { col: null, dir: null }; // dir: "asc" | "desc"
  // Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
  let activeFilters = [];
  // Debounce timer
  let searchDebounce;

  /***************** Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© *****************/
  // Ø¯Ø§Ù„Ø© CSV parser Ø¨Ø³ÙŠØ·Ø© Ù„ÙƒÙ†Ù‡Ø§ ØªØ¯Ø¹Ù… Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø·Ø© Ø¨Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù‚ØªØ¨Ø§Ø³ Ùˆcommas Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„
  function parseCSV(text){
    const rows = [];
    let cur = '';
    let row = [];
    let inQuotes = false;
    for (let i=0;i<text.length;i++){
      const ch = text[i];
      const next = text[i+1];
      if (ch === '"' ) {
        if (inQuotes && next === '"') { // escaped quote
          cur += '"';
          i++; // ØªØ®Ø·ÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠ
        } else {
          inQuotes = !inQuotes;
        }
      } else if (ch === ',' && !inQuotes){
        row.push(cur);
        cur = '';
      } else if ((ch === '\n' || ch === '\r') && !inQuotes){
        // handle CRLF and LF
        if (ch === '\r' && text[i+1] === '\n') { /* skip, will be handled once */ }
        if (cur !== '' || row.length>0) {
          row.push(cur);
          rows.push(row);
          row = [];
          cur = '';
        } else {
          // empty line -> skip
        }
      } else {
        cur += ch;
      }
    }
    // Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù
    if (cur !== '' || row.length>0) {
      row.push(cur);
      rows.push(row);
    }
    // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ ØµÙÙˆÙ ÙƒÙ„Ù‡Ø§ ÙØ§Ø±ØºØ©
    return rows.map(r => r.map(c => c.trim())).filter(r => r.some(cell => cell !== ""));
  }

  // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­ÙˆÙŠÙ„ Ù†Øµ Ø¥Ù„Ù‰ Ø±Ù‚Ù… (ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙÙˆØ§ØµÙ„ - Ø¢Ù„Ø§Ù - Ø¹Ù…Ù„Ø§Øª)
  function toNumber(value){
    if (value == null) return NaN;
    // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø±Ù…ÙˆØ² ØºÙŠØ± Ø±Ù‚Ù…ÙŠØ© Ø¥Ù„Ø§ Ø§Ù„Ù†Ù‚Ø·Ø© ÙˆØ§Ù„Ø³Ø§Ù„Ø¨
    const cleaned = value.replace(/[^\d\.\-\/]/g, '') // keep digits, dot, minus, slash
                         .replace(/,+/g,''); // remove commas
    const n = parseFloat(cleaned);
    return isNaN(n) ? NaN : n;
  }

  // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­ÙˆÙŠÙ„ Ù†Øµ Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ® (ÙŠØ¯Ø¹Ù… ØµÙŠØº Ø´Ø§Ø¦Ø¹Ø© dd/mm/yyyy Ø£Ùˆ yyyy-mm-dd Ø£Ùˆ dd-mm-yyyy)
  function toDate(value){
    if (!value) return null;
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª
    const v = value.trim();
    // Ø¥Ø°Ø§ ISO-like
    const iso = /^\d{4}-\d{1,2}-\d{1,2}$/;
    const dmy = /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/;
    if (iso.test(v)){
      const d = new Date(v);
      return isNaN(d.getTime()) ? null : d;
    }
    const m = v.match(dmy);
    if (m){
      let day = parseInt(m[1],10), month = parseInt(m[2],10), year = parseInt(m[3],10);
      if (year < 100) year += 2000;
      const d = new Date(year, month-1, day);
      return isNaN(d.getTime()) ? null : d;
    }
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ø§Ù…Ø©
    const tryDate = new Date(v);
    return isNaN(tryDate.getTime()) ? null : tryDate;
  }

  // Ù…Ù‚Ø§Ø±Ù†Ø© Ø°ÙƒÙŠØ© Ø¨ÙŠÙ† Ù‚ÙŠÙ…ØªÙŠÙ†: ØªØ­Ø§ÙˆÙ„ Ø£Ù† ØªØ¹ØªØ¨Ø±Ù‡Ø§ ØªØ§Ø±ÙŠØ® -> Ø±Ù‚Ù… -> Ù†Øµ
  function smartCompare(a, b){
    // null/empty handling
    if ((a==null || a==="") && (b==null || b==="")) return 0;
    if (a==null || a==="") return -1;
    if (b==null || b==="") return 1;

    // Ø§Ù„ØªØ§Ø±ÙŠØ®
    const da = toDate(a);
    const db = toDate(b);
    if (da && db) return da - db;

    // Ø±Ù‚Ù…
    const na = toNumber(a);
    const nb = toNumber(b);
    if (!isNaN(na) && !isNaN(nb)) return na - nb;

    // Ù†Øµ (localeCompare Ù„Ù„Ø¹Ø±Ø¨ÙŠØ©)
    return a.toString().localeCompare(b.toString(), 'ar');
  }

  /***************** Ø±Ù†Ø¯Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„ *****************/
  function renderTable(rows){
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";
    
    if (rows.length === 0) {
      document.getElementById("noResults").style.display = "block";
    } else {
      document.getElementById("noResults").style.display = "none";
      const maxShow = rows.length;
      for (let i=0;i<maxShow;i++){
        const r = rows[i];
        const tr = document.createElement("tr");
        for (let c=0;c<7;c++){
          const td = document.createElement("td");
          td.textContent = r[c] ?? "";
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
    }
    
    // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
    document.getElementById("info").textContent = `Ø¹Ø±Ø¶ ${rows.length} Ù†ØªÙŠØ¬Ø© Ù…Ù† ${originalRows.length} Ø³Ø¬Ù„`;
  }

  /***************** ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø© ÙˆØ§Ù„ÙØ±Ø² *****************/
  function applyFiltersAndSort(){
    // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
    document.getElementById("loading").classList.add("show");
    
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… setTimeout Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø«Ù‚ÙŠÙ„Ø©
    setTimeout(() => {
      // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù…
      const globalQ = document.getElementById("globalSearch").value.trim().toLowerCase();
      
      // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
      let filteredRows = originalRows;
      
      // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
      if (globalQ !== "") {
        filteredRows = filteredRows.filter(r => {
          return r.some(cell => (cell+"").toLowerCase().includes(globalQ));
        });
      }
      
      // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
      activeFilters.forEach(filter => {
        filteredRows = filteredRows.filter(row => {
          const cellValue = row[filter.column] || "";
          const searchValue = filter.value.toLowerCase();
          
          switch(filter.condition) {
            case "contains":
              return cellValue.toLowerCase().includes(searchValue);
            case "equals":
              return cellValue.toLowerCase() === searchValue;
            case "startsWith":
              return cellValue.toLowerCase().startsWith(searchValue);
            case "endsWith":
              return cellValue.toLowerCase().endsWith(searchValue);
            case "greater":
              const numValue = toNumber(cellValue);
              const numSearch = toNumber(filter.value);
              return !isNaN(numValue) && !isNaN(numSearch) && numValue > numSearch;
            case "less":
              const numValueL = toNumber(cellValue);
              const numSearchL = toNumber(filter.value);
              return !isNaN(numValueL) && !isNaN(numSearchL) && numValueL < numSearchL;
            default:
              return true;
          }
        });
      });
      
      // ØªØ·Ø¨ÙŠÙ‚ ÙÙ„Ø§ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø­Ø¯Ø¯Ø©
      const dateFrom = document.getElementById("dateFrom").value;
      const dateTo = document.getElementById("dateTo").value;
      
      if (dateFrom || dateTo) {
        filteredRows = filteredRows.filter(row => {
          const dateStr = row[4] || ""; // Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ù‡Ùˆ Ø§Ù„ØªØ§Ø±ÙŠØ®
          const date = toDate(dateStr);
          if (!date) return false;
          
          const fromDate = dateFrom ? new Date(dateFrom) : null;
          const toDateObj = dateTo ? new Date(dateTo) : null;
          
          if (fromDate && date < fromDate) return false;
          if (toDateObj && date > toDateObj) return false;
          
          return true;
        });
      }
      
      // ØªØ·Ø¨ÙŠÙ‚ ÙÙ„Ø§ØªØ± Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø­Ø¯Ø¯Ø©
      const valueMin = document.getElementById("valueMin").value;
      const valueMax = document.getElementById("valueMax").value;
      
      if (valueMin || valueMax) {
        filteredRows = filteredRows.filter(row => {
          const valueStr = row[2] || ""; // Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù†ÙŠ Ù‡Ùˆ Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙƒÙ„ÙŠÙ
          const value = toNumber(valueStr);
          if (isNaN(value)) return false;
          
          const min = valueMin ? parseFloat(valueMin) : -Infinity;
          const max = valueMax ? parseFloat(valueMax) : Infinity;
          
          return value >= min && value <= max;
        });
      }
      
      displayRows = filteredRows;
      
      // ÙØ±Ø² Ø°ÙƒÙŠ
      if (sortState.col !== null){
        const col = sortState.col;
        const dir = sortState.dir === "asc" ? 1 : -1;
        displayRows.sort((a,b) => {
          return smartCompare(a[col] || "", b[col] || "") * dir;
        });
      }
      
      renderTable(displayRows);
      
      // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
      document.getElementById("loading").classList.remove("show");
    }, 50);
  }

  /***************** Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø© *****************/
  function addFilter() {
    const column = document.getElementById("columnFilter").value;
    const value = document.getElementById("columnSearch").value.trim();
    const condition = document.getElementById("filterCondition").value;
    
    if (!value) return;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù‡Ø°Ø§ Ø§Ù„ÙÙ„ØªØ± Ù…Ø³Ø¨Ù‚Ø§Ù‹
    const filterExists = activeFilters.some(f => 
      f.column === column && f.value === value && f.condition === condition
    );
    
    if (filterExists) return;
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯
    activeFilters.push({
      column: column === "all" ? "all" : parseInt(column),
      value: value,
      condition: condition
    });
    
    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©
    updateFilterTags();
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±
    applyFiltersAndSort();
  }
  
  function removeFilter(index) {
    activeFilters.splice(index, 1);
    updateFilterTags();
    applyFiltersAndSort();
  }
  
  function updateFilterTags() {
    const container = document.getElementById("filterTags");
    container.innerHTML = "";
    
    activeFilters.forEach((filter, index) => {
      const tag = document.createElement("div");
      tag.className = "filter-tag";
      
      let columnName = "ÙƒÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©";
      if (filter.column !== "all") {
        const columnHeader = document.querySelector(`th[data-col="${filter.column}"]`);
        columnName = columnHeader ? columnHeader.textContent.split(' ')[0] : `Ø§Ù„Ø¹Ù…ÙˆØ¯ ${filter.column}`;
      }
      
      let conditionText = "";
      switch(filter.condition) {
        case "contains": conditionText = "ÙŠØ­ØªÙˆÙŠ"; break;
        case "equals": conditionText = "ÙŠØ³Ø§ÙˆÙŠ"; break;
        case "startsWith": conditionText = "ÙŠØ¨Ø¯Ø£ Ø¨Ù€"; break;
        case "endsWith": conditionText = "ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€"; break;
        case "greater": conditionText = "Ø£ÙƒØ¨Ø± Ù…Ù†"; break;
        case "less": conditionText = "Ø£Ù‚Ù„ Ù…Ù†"; break;
      }
      
      tag.innerHTML = `
        ${columnName} ${conditionText} "${filter.value}"
        <button type="button" onclick="removeFilter(${index})">Ã—</button>
      `;
      
      container.appendChild(tag);
    });
  }

  /***************** Ø¥Ø¹Ø¯Ø§Ø¯ ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© *****************/
  function setupUI(){
    // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù… Ù…Ø¹ debounce
    document.getElementById("globalSearch").addEventListener("input", () => {
      clearTimeout(searchDebounce);
      searchDebounce = setTimeout(() => applyFiltersAndSort(), 300);
    });
    
    // Ø¥Ø¶Ø§ÙØ© ÙÙ„ØªØ±
    document.getElementById("addFilterBtn").addEventListener("click", addFilter);
    
    // Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ø¨Ø­Ø« Ù…Ø¹ debounce
    document.getElementById("columnSearch").addEventListener("input", () => {
      clearTimeout(searchDebounce);
      searchDebounce = setTimeout(() => applyFiltersAndSort(), 300);
    });
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
    document.getElementById("resetBtn").addEventListener("click", () => {
      document.getElementById("globalSearch").value = "";
      document.getElementById("columnSearch").value = "";
      document.getElementById("dateFrom").value = "";
      document.getElementById("dateTo").value = "";
      document.getElementById("valueMin").value = "";
      document.getElementById("valueMax").value = "";
      activeFilters = [];
      sortState = { col: null, dir: null };
      
      // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ÙØ±Ø²
      for (let i=0;i<7;i++) document.getElementById("sort-"+i).textContent = "";
      
      updateFilterTags();
      applyFiltersAndSort();
    });
    
    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
    document.getElementById("toggleFilters").addEventListener("click", () => {
      document.getElementById("advancedFilters").classList.toggle("show");
    });
    
    // Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
    document.getElementById("dateFrom").addEventListener("change", () => applyFiltersAndSort());
    document.getElementById("dateTo").addEventListener("change", () => applyFiltersAndSort());
    document.getElementById("valueMin").addEventListener("input", () => {
      clearTimeout(searchDebounce);
      searchDebounce = setTimeout(() => applyFiltersAndSort(), 300);
    });
    document.getElementById("valueMax").addEventListener("input", () => {
      clearTimeout(searchDebounce);
      searchDebounce = setTimeout(() => applyFiltersAndSort(), 300);
    });

    // ÙØ±Ø² Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
    document.querySelectorAll("#dataTable thead th").forEach(th => {
      th.addEventListener("click", () => {
        const col = parseInt(th.dataset.col,10);
        if (sortState.col === col){
          // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø§ØªØ¬Ø§Ù‡
          sortState.dir = sortState.dir === "asc" ? "desc" : "asc";
        } else {
          sortState.col = col;
          sortState.dir = "asc";
        }
        // ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„ÙØ±Ø²
        for (let i=0;i<7;i++){
          const el = document.getElementById("sort-"+i);
          if (i === sortState.col) el.textContent = (sortState.dir === "asc" ? "â–²" : "â–¼");
          else el.textContent = "";
        }
        applyFiltersAndSort();
      });
    });

    // Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ± (ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø±Ø´Ø­Ø© ÙÙ‚Ø·)
    document.getElementById("exportBtn").addEventListener("click", () => {
      if (!displayRows || displayRows.length === 0){
        alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±.");
        return;
      }
      // ØªØ´ÙƒÙŠÙ„ CSV Ù…Ù† displayRows
      const header = ["Ø§Ø³Ù… Ø§Ù„Ù…ÙƒÙ„Ù","Ø¨ÙŠØ§Ù† Ø§Ù„Ø¹Ù…Ù„","Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙƒÙ„ÙŠÙ","Ø±Ù‚Ù… Ø§Ù„ØªÙƒÙ„ÙŠÙ","Ø§Ù„ØªØ§Ø±ÙŠØ®","Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„","Ø§Ù„Ù…Ø¯Ø©"];
      const lines = [header.map(escapeCSV).join(",")];
      displayRows.forEach(r => {
        const line = [];
        for (let i=0;i<7;i++) line.push(escapeCSV(r[i] || ""));
        lines.push(line.join(","));
      });
      const csvContent = lines.join("\r\n");
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'taklef_export.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });
  }

  function escapeCSV(val){
    if (val == null) return "";
    const s = val.toString();
    if (s.includes(',') || s.includes('"') || s.includes('\n') || s.includes('\r')) {
      return '"' + s.replace(/"/g,'""') + '"';
    }
    return s;
  }

  /***************** ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Sheets CSV *****************/
  async function loadDataFromCSV(){
    try {
      document.getElementById("loading").classList.add("show");
      const resp = await fetch(SHEET_CSV_URL);
      if (!resp.ok) throw new Error("ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù„Ù: " + resp.status);
      const text = await resp.text();
      const parsed = parseCSV(text);

      if (parsed.length === 0){
        alert("Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù† Ù‚Ø±Ø§Ø¡ØªÙ‡.");
        return;
      }

      // Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø£ÙˆÙ„ Ù‡Ùˆ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† â€” Ù†Ø£Ø®Ø° Ø§Ù„Ø¨Ø§Ù‚ÙŠ ÙƒØ¨ÙŠØ§Ù†Ø§Øª
      originalRows = parsed.slice(1).map(r => {
        // Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ 7 Ø£Ø¹Ù…Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„
        const row = [];
        for (let i=0;i<7;i++) row[i] = (r[i] !== undefined) ? r[i] : "";
        return row;
      }).filter(r => r.some(c => c !== "")); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙÙˆÙ Ø§Ù„ÙØ§Ø±ØºØ©

      // Ø¹Ø±Ø¶ Ø£ÙˆÙ„ÙŠ
      setupUI();
      applyFiltersAndSort();
      document.getElementById("loading").classList.remove("show");
    } catch (err) {
      console.error(err);
      alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + err.message);
    }
  }

  // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
  loadDataFromCSV();
  </script>
</body>
</html>